<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Solar Hat — Smart Wearable Guide</title>
  
  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS (for embedded map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --page-bg: #f0f9ff;
      --nav-bg: #ffffff;
      --muted: #5e718d;
      --text: #0f1a2f;
      --accent: #0ea5a4;
      --accent-2: #2b9df4;
      --accent-light: #d1f0ef;
      --card-radius: 18px;
      --max-width: 1100px;
      --shadow: 0 6px 18px rgba(2, 6, 23, 0.08);
      --shadow-hover: 0 12px 30px rgba(2, 6, 23, 0.12);
      --glass: rgba(255,255,255,0.6);
      --glass-border: rgba(15,23,35,0.06);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--page-bg);color:var(--text);-webkit-font-smoothing:antialiased;line-height:1.5}
    body{display:flex;flex-direction:column;min-height:100vh}
    .container { max-width: var(--max-width); margin: 0 auto; padding: 18px; width: 100%; flex:1 }

    /* Header */
    .header { background: var(--nav-bg); box-shadow: var(--shadow); padding: 12px 16px; position: sticky; top: 0; z-index: 100; transition: transform 320ms ease, box-shadow 200ms ease; }
    .header-hidden { transform: translateY(-100%); box-shadow: none; }
    .header-inner { max-width: var(--max-width); margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(14, 165, 164, 0.15); }
    .logo-text { font-weight: 800; font-size: 20px; color: var(--text); letter-spacing: -0.5px; }
    .menu-toggle { background: none; border: none; width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
    .menu-toggle:hover { background: var(--accent-light); }

    nav { position: fixed; top: 68px; left: 0; right: 0; background: var(--nav-bg); box-shadow: 0 12px 25px rgba(0,0,0,0.08); padding: 16px; z-index: 99; transform: translateY(-150%); transition: transform 0.32s ease; border-radius: 0 0 12px 12px; }
    nav.active { transform: translateY(0); }
    nav ul { list-style: none; display: flex; flex-direction: column; gap: 8px; padding: 0; margin: 0; }
    nav a { display: block; color: var(--muted); text-decoration: none; padding: 12px; border-radius: 12px; font-weight: 600; transition: all 0.2s; font-size: 15px; }
    nav a:hover { background: var(--accent-light); color: var(--accent); }

    /* main card styles */
    .status-section { background: white; border-radius: var(--card-radius); padding: 18px; box-shadow: var(--shadow); margin-top: 16px; border: 1px solid var(--glass-border); }
    .status-card { padding: 12px; border-radius: 12px; background: linear-gradient(180deg, rgba(14,165,164,0.03), rgba(43,157,244,0.02)); }
    .status-label { font-size: 14px; color: var(--muted); display:flex; gap:8px; align-items:center; font-weight:600; }
    .status-value { font-weight:700; font-size:18px; color:var(--text); margin-top:8px; }

    .location-details { margin-top: 14px; }
    .location-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(15,23,35,0.04); }
    .location-label { color:var(--muted); }
    .location-value { font-weight:700; }

    .controls { display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
    .btn { background: var(--accent); color:white; padding:12px 16px; border-radius:10px; border: none; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:10px; box-shadow: 0 6px 12px rgba(14,165,164,0.12); }
    .btn.gray { background: white; color:var(--muted); border:1px solid rgba(15,23,35,0.06); box-shadow:none; }
    .btn.small { padding:8px 10px; font-size:13px; }

    /* cards */
    .hero-head { margin: 26px 0 18px; }
    .hero-head h2 { font-size:22px; margin-bottom:6px; font-weight:800; }
    .hero-head p.lead { color:var(--muted); font-size:15px; max-width:720px; }

    .cards { display:grid; gap:18px; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); margin-bottom:24px; }
    .card { background:white; border-radius:16px; padding:20px; text-align:center; box-shadow: var(--shadow); border:1px solid rgba(15,23,35,0.03); cursor:pointer; transition: transform .28s ease, box-shadow .28s ease; }
    .card:hover { transform: translateY(-6px); box-shadow: var(--shadow-hover); }
    .card-logo { width:70px; height:70px; border-radius:50%; margin:0 auto 12px; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 8px 16px rgba(0,0,0,0.08); color:white; }
    .title { font-weight:800; font-size:16px; margin-bottom:6px; }
    .desc { color:var(--muted); font-size:13px; }

    /* map */
    .map-container { margin-top:12px; height:280px; border-radius:12px; overflow:hidden; border:1px solid rgba(15,23,35,0.06); background:linear-gradient(180deg, rgba(14,165,164,0.02), rgba(43,157,244,0.01)); }
    #map { width:100%; height:100%; display:block; background: rgba(14,165,164,0.03); }

    /* loading */
    .loading { display:inline-block; width:16px; height:16px; border:2px solid rgba(14,165,164,0.25); border-radius:50%; border-top-color:var(--accent); animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- Weather visuals (improved) --- */
    .weather-wrap { margin-top:18px; display:grid; grid-template-columns: 1fr; gap:12px; }
    .weather-glass {
      position:relative;
      overflow:hidden;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
      border: 1px solid rgba(255,255,255,0.5);
      box-shadow: 0 12px 30px rgba(2,6,23,0.06);
      display:flex;
      gap:14px;
      padding:16px;
      align-items:center;
      transition: transform 360ms cubic-bezier(.2,.9,.2,1), box-shadow 260ms ease;
      backdrop-filter: blur(6px);
    }
    .weather-left {
      width:132px;
      height:132px;
      border-radius:12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      background: linear-gradient(135deg, rgba(14,165,164,0.12), rgba(43,157,244,0.06));
      box-shadow: inset 0 -6px 20px rgba(14,165,164,0.03);
      transition: transform .36s ease;
    }
    .weather-icon { font-size:44px; margin-bottom:8px; }
    .weather-temp-big { font-size:28px; font-weight:900; letter-spacing:-1px; }

    .weather-right { flex:1; min-width:180px; }
    .weather-cond { font-weight:800; font-size:16px; color:var(--text); margin-bottom:6px; }
    .weather-meta { display:flex; gap:10px; flex-wrap:wrap; }
    .meta-pill {
      background: rgba(15,23,35,0.03);
      border-radius:10px; padding:8px 10px; font-weight:700; color:var(--muted); font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
    }

    /* gentle animated background depending on condition */
    .bg-sunny { background-image: linear-gradient(120deg, rgba(255,238,170,0.22), rgba(255,255,255,0.6)); }
    .bg-cloudy { background-image: linear-gradient(120deg, rgba(220,230,240,0.12), rgba(255,255,255,0.6)); }
    .bg-rain { background-image: linear-gradient(120deg, rgba(200,220,235,0.12), rgba(245,252,255,0.6)); }
    .bg-snow { background-image: linear-gradient(120deg, rgba(230,240,250,0.14), rgba(255,255,255,0.6)); }

    .small-muted { color:var(--muted); font-size:13px; }

    /* footer */
    footer.footer {
      padding:14px 18px;
      text-align:center;
      font-size:13px;
      color:var(--muted);
      border-top:1px solid rgba(15,23,35,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.25));
    }

    @media (min-width:768px) {
      nav { position: static; transform:none; box-shadow:none; padding:0; }
      nav ul { flex-direction:row; gap:10px; }
      .weather-wrap { grid-template-columns: 320px 1fr; }
    }

    @media (max-width:480px) {
      .cards { grid-template-columns: 1fr; }
      .weather-left { width:96px; height:96px; }
      .weather-temp-big { font-size:22px; }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header" id="siteHeader">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="white"><path d="M12 3L2 12l3 3v6h5v-5h4v5h5v-6l3-3-10-9zm0 9c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg>
        </div>
        <div class="logo-text">Solar Hat</div> <!-- space for TTS clarity -->
      </div>
      
      <button class="menu-toggle" id="menuToggle" aria-label="Open menu">
        <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18"><path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round"/></svg>
      </button>
    </div>
    
    <nav id="mainNav" aria-hidden="true">
      <ul>
        <li class="active"><a href="#home">Home</a></li>
        <li><a href="#news">News</a></li>
        <li><a href="#contact">Contact</a></li>
        <li><a href="#about">About</a></li>
      </ul>
    </nav>
  </header>
  
  <div class="container">
    <!-- Location Section -->
    <section class="status-section" aria-labelledby="locTitle">
      <div class="status-card">
        <div class="status-label" id="locTitle" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"><path d="M17.657 16.657L13.414 20.9a2 2 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke-width="1.4"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" stroke-width="1.4"/></svg>
          Current Location
        </div>

        <div class="status-value" id="coords">—</div>

        <div class="location-details">
          <div class="location-row">
            <span class="location-label">Accuracy</span>
            <span class="location-value" id="accuracy">—</span>
          </div>

          <div class="temp-row" aria-live="polite" style="margin-top:10px;">
            <span class="location-label">Temperature:</span>
            <strong id="temperature" class="temp-value">—</strong>
            <button class="btn gray small" id="refreshTempBtn" title="Refresh temperature">Refresh</button>
          </div>

          <div class="map-container" id="mapContainer" aria-hidden="true">
            <div id="map" role="application" aria-label="Embedded map">Map will appear here when location is available</div>
          </div>

          <div class="controls">
            <button class="btn" id="locBtn" title="Start location">Get Location</button>
            <button class="btn gray" id="stopLocBtn" style="display:none">Stop</button>
            <button class="btn gray" id="openMapsBtn" style="display:none">Open in Maps</button>
            <button class="btn gray" id="muteBtn">Mute</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Weather (improved look) -->
    <section class="status-section" aria-labelledby="weatherTitle">
      <div class="status-card">
        <div class="status-label" id="weatherTitle" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"><path d="M12 3v2m0 14v2m9-9h-2M5 12H3"></path></svg>
          Current Weather (Live)
        </div>

        <div class="weather-wrap" id="weatherWrap">
          <div id="weatherGlass" class="weather-glass bg-cloudy" role="region" aria-live="polite">
            <div class="weather-left" aria-hidden="true">
              <div id="weatherIcon" class="weather-icon">—</div>
              <div id="weatherTemp" class="weather-temp-big">—</div>
              <div class="small-muted" id="weatherSource">—</div>
            </div>

            <div class="weather-right">
              <div id="weatherCond" class="weather-cond">—</div>
              <div class="weather-meta">
                <div class="meta-pill">Humidity <strong id="weatherHumidity" style="margin-left:8px">—</strong></div>
                <div class="meta-pill">Wind <strong id="weatherWind" style="margin-left:8px">—</strong></div>
                <div class="meta-pill small-muted" id="weatherExtras">Updated just now</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Cards (restored) -->
    <section class="hero" aria-label="Explore sections">
      <div class="hero-head">
        <h2>Explore Solar Hat Features</h2>
        <p class="lead">Tap any card to hear location-based audio guidance. Your Solar Hat will provide context-aware information as you explore.</p>
      </div>

      <div class="cards" role="list">
        <article class="card" role="listitem" data-key="location" data-message="You are near the main plaza. Enjoy the panoramic view of the city.">
          <div class="card-logo" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="white"><path d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"/></svg></div>
          <div class="title">Location Guide</div>
          <p class="desc">Nearby points of interest</p>
        </article>

        <article class="card" role="listitem" data-key="rent" data-message="Rent a Solar Hat for your adventure. Available at multiple locations throughout the city.">
          <div class="card-logo"><svg viewBox="0 0 24 24" fill="none" stroke="white"><path d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z"/></svg></div>
          <div class="title">Rent a Hat</div>
          <p class="desc">Browse available rentals</p>
        </article>

        <article class="card" role="listitem" data-key="about" data-message="Solar Hat: Sustainable wearable technology powered by sunlight with location-aware audio.">
          <div class="card-logo"><svg viewBox="0 0 24 24" fill="none" stroke="white"><path d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021"/></svg></div>
          <div class="title">About Us</div>
          <p class="desc">Our vision and technology</p>
        </article>

        <article class="card" role="listitem" data-key="services" data-message="Services include audio tours, navigation assistance, and location-based information.">
          <div class="card-logo"><svg viewBox="0 0 24 24" fill="none" stroke="white"><path d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"/></svg></div>
          <div class="title">Services</div>
          <p class="desc">What Solar Hat offers</p>
        </article>

        <article class="card" role="listitem" data-key="contact" data-message="Contact Solar Hat support at support@solarhat.com or call 1-800-SOLAR-HAT.">
          <div class="card-logo"><svg viewBox="0 0 24 24" fill="none" stroke="white"><path d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417"/></svg></div>
          <div class="title">Contact Support</div>
          <p class="desc">Get in touch with us</p>
        </article>

        <article class="card" role="listitem" data-key="testimonials" data-message="Our customers love the Solar Hat experience. Read testimonials from satisfied users.">
          <div class="card-logo"><svg viewBox="0 0 24 24" fill="none" stroke="white"><path d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
          <div class="title">Testimonials</div>
          <p class="desc">Customer experiences</p>
        </article>
      </div>
    </section>

    <div class="note" style="margin-top:12px;font-size:13px;color:var(--muted)">Tip: Tap any card to hear its message. Use Get Location for precise GPS positioning. Map appears after location is acquired.</div>
  </div>

  <footer class="footer">Developed by Kurdistan Innovators</footer>

  <!-- Leaflet JS (for embedded map) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /************************************************************************
     * UI improvements & weather visuals
     * - keeps previous functionality: geolocation watch, Open-Meteo, fallback
     * - nicer weather card with condition-based gentle background
     * - prevents repeated audio and duplicate geolocation watchers
     ************************************************************************/

    /* ---------- Simple helpers ---------- */
    const q = sel => document.querySelector(sel);
    const qa = sel => Array.from(document.querySelectorAll(sel));

    /* ---------- Menu toggle ---------- */
    const menuToggle = q('#menuToggle'), mainNav = q('#mainNav');
    if (menuToggle) menuToggle.addEventListener('click', e => { e.stopPropagation(); mainNav.classList.toggle('active'); });
    document.addEventListener('click', e => { if (mainNav && !mainNav.contains(e.target) && !menuToggle.contains(e.target)) mainNav.classList.remove('active'); });

    /* ---------- Header hide on scroll ---------- */
    (function headerHide() {
      const header = q('#siteHeader');
      if (!header) return;
      let last = window.scrollY || 0, ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            const cur = window.scrollY || 0, d = cur - last;
            if (cur > 60 && d > 6) header.classList.add('header-hidden');
            else if (d < -6 || cur <= 60) header.classList.remove('header-hidden');
            last = cur; ticking = false;
          });
          ticking = true;
        }
      }, {passive:true});
    })();

    /* ---------- TTS (dedupe + cooldown) ---------- */
    let ttsEnabled = true;
    const muteBtn = q('#muteBtn');
    if (muteBtn) muteBtn.addEventListener('click', () => { ttsEnabled = !ttsEnabled; updateMute(); if (!ttsEnabled && 'speechSynthesis' in window) speechSynthesis.cancel(); });
    function updateMute() {
      if (!muteBtn) return;
      muteBtn.textContent = ttsEnabled ? 'Mute' : 'Unmute';
    }
    updateMute();
    let lastSpeak = '', lastSpeakTime = 0;
    const SPEECH_COOLDOWN_MS = 4000;
    function speak(text, options={}) {
      // make sure "Solar Hat" is pronounced nicely
      text = String(text).replace(/SolarHat/g, 'Solar Hat');
      if (!ttsEnabled) return;
      if (!('speechSynthesis' in window)) return;
      const now = Date.now();
      const same = String(text).trim() === lastSpeak.trim();
      if (!options.force) {
        if (same && (now - lastSpeakTime) < SPEECH_COOLDOWN_MS) return;
        if (!same && (now - lastSpeakTime) < 800) return;
      }
      try {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1; u.pitch = 1; u.volume = 1;
        u.onerror = (e) => console.error('TTS error', e);
        speechSynthesis.speak(u);
        lastSpeak = String(text);
        lastSpeakTime = now;
      } catch (e) { console.error(e); }
    }

    /* ---------- Card click TTS ---------- */
    qa('.card').forEach(card => card.addEventListener('click', () => {
      const msg = card.dataset.message || `Opening ${card.dataset.key || 'section'}`;
      speak(msg, {force:false});
      card.animate([{ transform: 'scale(.98)', opacity:.95 }, { transform: 'scale(1)', opacity:1 }], { duration:260, easing:'ease-out' });
    }));

    /* ---------- Map, Geolocation & Weather logic ---------- */
    const locBtn = q('#locBtn'), stopLocBtn = q('#stopLocBtn');
    const coordsEl = q('#coords'), accEl = q('#accuracy'), openMapsBtn = q('#openMapsBtn');
    const tempEl = q('#temperature'), refreshBtn = q('#refreshTempBtn');
    const mapContainer = q('#mapContainer'), mapEl = q('#map');

    // Weather UI
    const wTemp = q('#weatherTemp'), wIcon = q('#weatherIcon'), wCond = q('#weatherCond');
    const wHum = q('#weatherHumidity'), wWind = q('#weatherWind'), wSource = q('#weatherSource'), wExtras = q('#weatherExtras');
    const weatherGlass = q('#weatherGlass');

    let watchId = null;
    let map = null, userMarker = null, accuracyCircle = null;
    const INITIAL_ZOOM = 15;

    // control repeated speech & weather calls
    let lastSpokenLocation = null; // {lat,lon,acc}
    let lastWeather = {time:0, coords:null};

    function movedMetersApprox(lat1, lon1, lat2, lon2) {
      const latDiff = Math.abs(lat1 - lat2);
      const lonDiff = Math.abs(lon1 - lon2);
      return Math.sqrt((latDiff*111320)**2 + (lonDiff*111320*Math.cos(lat1*Math.PI/180))**2);
    }

    function locationShouldSpeak(lat, lon, acc) {
      if (!lastSpokenLocation) return true;
      const moved = movedMetersApprox(lat, lon, lastSpokenLocation.lat, lastSpokenLocation.lon);
      if (moved > 50) return true;
      if ((lastSpokenLocation.acc - acc) > 20) return true;
      return false;
    }
    function recordSpokenLocation(lat, lon, acc) { lastSpokenLocation = {lat,lon,acc}; }

    function ensureMap(lat, lon) {
      if (mapContainer.style.display !== 'block') { mapContainer.style.display = 'block'; mapContainer.setAttribute('aria-hidden','false'); }
      if (!map) {
        map = L.map('map', { zoomControl:true }).setView([lat, lon], INITIAL_ZOOM);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          maxZoom: 19, attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
        }).addTo(map);
      }
    }

    function updateMap(lat, lon, accuracy) {
      if (!map) ensureMap(lat, lon);
      const pt = [lat, lon];
      if (!userMarker) {
        userMarker = L.marker(pt, { icon: L.divIcon({ className:'user-location-marker', html:'<div style=\"width:16px;height:16px;border-radius:50%;background:#0ea5a4;box-shadow:0 0 0 6px rgba(14,165,164,0.08);\"></div>', iconSize:[30,30], iconAnchor:[15,15] }) }).addTo(map);
      } else userMarker.setLatLng(pt);
      if (!accuracyCircle) {
        accuracyCircle = L.circle(pt, { radius: accuracy, color:'#0ea5a4', fillColor:'#d1f0ef', fillOpacity:0.22 }).addTo(map);
      } else { accuracyCircle.setLatLng(pt); accuracyCircle.setRadius(accuracy); }
      map.setView(pt, map.getZoom());
    }

    function showLocError(err) {
      switch(err.code) {
        case err.PERMISSION_DENIED: alert('Location access denied. Please allow location access.'); break;
        case err.POSITION_UNAVAILABLE: alert('Location unavailable.'); break;
        case err.TIMEOUT: alert('Location request timed out.'); break;
        default: alert('Unknown geolocation error.'); break;
      }
    }

    async function updateLocationUI(position) {
      const lat = position.coords.latitude, lon = position.coords.longitude;
      const latF = lat.toFixed(6), lonF = lon.toFixed(6);
      const acc = Math.round(position.coords.accuracy || 0);

      coordsEl.textContent = `${latF}, ${lonF}`;
      accEl.textContent = `${acc} m`;
      openMapsBtn.style.display = 'inline-flex';
      stopLocBtn.style.display = 'inline-flex';
      if (acc <= 30) accEl.style.color = '#10b981'; else if (acc <= 100) accEl.style.color = '#f59e0b'; else accEl.style.color = '#ef4444';

      // speak only when meaningful
      if (locationShouldSpeak(lat, lon, acc)) { speak(`Location acquired. Accuracy within ${acc} meters.`); recordSpokenLocation(lat, lon, acc); }

      try { ensureMap(lat, lon); updateMap(lat, lon, acc); } catch(e){ console.error('Map error', e); mapEl.textContent = 'Failed to load map'; }

      // Weather fetch: rate limited (2 minutes) or if moved > ~100m
      const now = Date.now();
      const needWeather = !lastWeather.coords || (now - lastWeather.time > 120000) || movedMetersApprox(lat, lon, lastWeather.coords.lat, lastWeather.coords.lon) > 100;
      if (needWeather) {
        lastWeather.coords = {lat, lon};
        lastWeather.time = now;
        const ok = await fetchOpenMeteoWeather(lat, lon, !lastWeather.spokenOnce);
        if (ok) lastWeather.spokenOnce = true;
        else {
          // fallback simulated
          const sim = simulateWeatherFor(lat, lon);
          applyWeather(sim, 'Simulated (fallback)');
        }
      }
    }

    // Prevent multiple watchers
    function startWatch() {
      if (!('geolocation' in navigator)) { alert('Geolocation not supported'); return; }
      if (watchId !== null) { speak('Already tracking your location.'); return; }
      locBtn.disabled = true; locBtn.textContent = 'Locating...';
      coordsEl.textContent = 'Locating...'; accEl.textContent = '—'; tempEl.textContent = '—';

      watchId = navigator.geolocation.watchPosition(pos => {
        updateLocationUI(pos);
        locBtn.disabled = false;
        locBtn.innerHTML = 'Get Location';
      }, err => {
        showLocError(err);
        locBtn.disabled = false; locBtn.innerHTML = 'Get Location';
        coordsEl.textContent = 'Failed';
        tempEl.textContent = '—';
        if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
      }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    }

    function stopWatch() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId); watchId = null;
        stopLocBtn.style.display = 'none';
        speak('Location tracking stopped.');
      }
    }

    if (locBtn) locBtn.addEventListener('click', startWatch);
    if (stopLocBtn) stopLocBtn.addEventListener('click', stopWatch);
    if (openMapsBtn) openMapsBtn.addEventListener('click', () => {
      const txt = coordsEl.textContent;
      if (!txt || txt === '—' || txt === 'Locating...') return;
      const [lat, lon] = txt.split(',').map(s => s.trim());
      window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`, '_blank');
    });

    if (refreshBtn) refreshBtn.addEventListener('click', async () => {
      const txt = coordsEl.textContent;
      if (!txt || txt === '—' || txt === 'Locating...') { tempEl.textContent = 'No location'; return; }
      const [lat, lon] = txt.split(',').map(s => s.trim());
      if (!lat || !lon) return;
      const ok = await fetchOpenMeteoWeather(Number(lat), Number(lon), true);
      if (!ok) {
        const sim = simulateWeatherFor(Number(lat), Number(lon));
        applyWeather(sim, 'Simulated (fallback)');
        speak(`Current temperature is ${sim.temperatureC.toFixed(1)} degrees Celsius and ${sim.condition}.`, {force:true});
        tempEl.textContent = `${sim.temperatureC.toFixed(1)} °C`;
      }
    });

    /* ---------- Open-Meteo fetching (no key) ---------- */
    const weatherCodeMap = {
      0:['Clear sky','☀️'],1:['Mainly clear','🌤️'],2:['Partly cloudy','⛅'],3:['Overcast','☁️'],
      45:['Fog','🌫️'],48:['Rime fog','🌫️'],51:['Light drizzle','🌦️'],53:['Moderate drizzle','🌧️'],
      55:['Dense drizzle','🌧️'],61:['Slight rain','🌧️'],63:['Moderate rain','🌧️'],65:['Heavy rain','🌧️'],
      71:['Slight snow','❄️'],73:['Moderate snow','❄️'],75:['Heavy snow','❄️'],80:['Rain showers','🌦️'],
      95:['Thunderstorm','⛈️']
    };

    async function fetchOpenMeteoWeather(lat, lon, speakOnFetch=false) {
      try {
        const ep = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current_weather=true&hourly=relativehumidity_2m&timezone=auto`;
        if (wSource) wSource.textContent = 'Open-Meteo';
        if (tempEl) tempEl.innerHTML = 'Loading <span class="loading"></span>';
        const resp = await fetch(ep, {cache:'no-store'});
        if (!resp.ok) throw new Error('Open-Meteo error');
        const data = await resp.json();
        if (!data || !data.current_weather) throw new Error('No current_weather');

        const cw = data.current_weather;
        const temperature = Number(cw.temperature);
        const wind = Number(cw.windspeed);
        const code = Number(cw.weathercode);

        // find nearest humidity entry from hourly arrays
        let humidity = '—';
        if (data.hourly && data.hourly.time && data.hourly.relativehumidity_2m) {
          const times = data.hourly.time, rh = data.hourly.relativehumidity_2m;
          let bestIdx = 0, bestDiff = Infinity;
          for (let i=0;i<times.length;i++){
            const t = new Date(times[i]);
            const diff = Math.abs(t - new Date());
            if (diff < bestDiff) { bestIdx = i; bestDiff = diff; }
          }
          humidity = (typeof rh[bestIdx] !== 'undefined') ? `${Math.round(rh[bestIdx])}%` : '—';
        }

        const mapVal = weatherCodeMap[code] || ['Clear','🌤️'];
        const conditionText = mapVal[0], conditionIcon = mapVal[1];

        const weather = {
          temperatureC: temperature,
          humidity: humidity,
          windKmh: `${wind} km/h`,
          condition: conditionText,
          icon: conditionIcon
        };

        applyWeather(weather, 'Open-Meteo');
        if (speakOnFetch) speak(`Current temperature is ${temperature.toFixed(1)} degrees Celsius and ${conditionText}.`, {force:true});
        if (tempEl) tempEl.textContent = `${temperature.toFixed(1)} °C`;
        return true;
      } catch (err) {
        console.warn('Open-Meteo failed', err);
        if (wSource) wSource.textContent = 'Simulated (fallback)';
        if (tempEl) tempEl.textContent = 'Unavailable';
        return false;
      }
    }

    /* ---------- Apply weather to UI + graceful visuals ---------- */
    function applyWeather(w, source='Simulated') {
      if (wTemp) wTemp.textContent = `${w.temperatureC.toFixed(1)}°C`;
      if (wIcon) wIcon.textContent = w.icon || '—';
      if (wCond) wCond.textContent = w.condition || '—';
      if (wHum) wHum.textContent = w.humidity || '—';
      if (wWind) wWind.textContent = w.windKmh || '—';
      if (wSource) wSource.textContent = source || '—';
      if (wExtras) wExtras.textContent = `Updated ${new Date().toLocaleTimeString()}`;

      // Gentle style: pick background class by condition
      const c = (w.condition || '').toLowerCase();
      weatherGlass.classList.remove('bg-sunny','bg-cloudy','bg-rain','bg-snow');
      if (c.includes('rain') || c.includes('drizzle') || c.includes('thunder')) weatherGlass.classList.add('bg-rain');
      else if (c.includes('snow')) weatherGlass.classList.add('bg-snow');
      else if (c.includes('clear') || c.includes('sun')) weatherGlass.classList.add('bg-sunny');
      else weatherGlass.classList.add('bg-cloudy');

      // small animation to highlight update
      weatherGlass.animate([{ transform: 'translateY(4px)', opacity: 0.96 }, { transform: 'translateY(0)', opacity:1 }], { duration: 420, easing: 'cubic-bezier(.2,.9,.2,1)' });
    }

    /* ---------- Fallback simulated weather ---------- */
    function simulateWeatherFor(lat, lon) {
      // deterministic pseudo-random based on coords so UI is consistent for same location
      const seed = Math.abs(Math.floor((lat*10000) ^ (lon*10000)));
      function rnd(min,max) { const x = Math.sin(seed + min*9973 + max*7919) * 43758.5453; const n = Math.abs(x - Math.floor(x)); return min + n*(max-min); }
      const latAbs = Math.abs(lat);
      const base = 28 - (latAbs/90)*40;
      const t = base + rnd(-4,4);
      const humidity = Math.max(8, Math.min(95, Math.round(50 + rnd(-28,28))));
      const wind = Math.max(0, +(rnd(0,22)).toFixed(1));
      const r = rnd(0,100);
      let cond = 'Partly cloudy';
      if (r < 10 && t < 2) cond = 'Snow';
      else if (r < 25 && t < 15) cond = 'Light rain';
      else if (r < 55) cond = (t > 25 ? 'Sunny' : 'Partly cloudy');
      else cond = 'Cloudy';
      const icon = cond.toLowerCase().includes('snow') ? '❄️' : cond.toLowerCase().includes('rain') ? '🌧️' : cond.toLowerCase().includes('cloud') ? '☁️' : '☀️';
      return { temperatureC: Number(t.toFixed(1)), humidity: `${humidity}%`, windKmh: `${wind} km/h`, condition: cond, icon };
    }

    /* ---------- small decorative map marker style ---------- */
    (function injectMapPulse() {
      const s = document.createElement('style');
      s.textContent = `
        .user-location-marker { pointer-events:none; }
      `;
      document.head.appendChild(s);
    })();

    // On load: quick try to populate if permission already granted
    (function tryOnce() {
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(pos => { try { updateLocationUI(pos); } catch (e) {} }, () => {}, { enableHighAccuracy:true, maximumAge:60000, timeout:6000 });
      }
    })();

    /* ---------- End of script ---------- */
  </script>
</body>
</html>
