<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Solar Hat ‚Äî Smart Wearable Guide (Improved)</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    /* ---------- Simple single theme (kept constant) ---------- */
    :root{
      --page-bg: #f0f9ff;
      --nav-bg: #ffffff;
      --muted: #5e718d;
      --text: #0f1a2f;
      --accent: #0ea5a4;
      --accent-2: #2b9df4;
      --card-bg: #ffffff;
      --card-radius: 16px;
      --shadow: 0 8px 24px rgba(2,6,23,0.06);
      --glass-border: rgba(15,23,35,0.06);
      --max-width: 1100px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:'Inter',system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--page-bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .container{max-width:var(--max-width);margin:0 auto;padding:18px}

    /* Header */
    .header{background:var(--nav-bg);box-shadow:var(--shadow);padding:12px 16px;position:sticky;top:0;z-index:100;backdrop-filter:blur(6px)}
    .header-inner{display:flex;align-items:center;justify-content:space-between;max-width:var(--max-width);margin:0 auto}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-icon{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff}
    .logo-text{font-weight:800;font-size:18px;background:linear-gradient(135deg,var(--accent),var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .menu-toggle{background:none;border:none;width:44px;height:44px;border-radius:10px;cursor:pointer}

    nav{position:static}
    nav ul{display:flex;gap:12px;list-style:none}
    nav a{color:var(--muted);text-decoration:none;font-weight:600;padding:8px 10px;border-radius:8px}
    nav a:hover{color:var(--accent)}

    /* Main cards and status */
    .status-section{background:var(--card-bg);border-radius:var(--card-radius);padding:20px;box-shadow:var(--shadow);border:1px solid var(--glass-border);margin-top:16px}
    .status-label{font-weight:700;color:var(--muted);display:flex;gap:8px;align-items:center}
    .status-value{font-weight:800;font-size:20px;margin-top:8px}

    .location-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(15,23,35,0.04)}
    .location-row:last-child{border-bottom:none}
    .location-label{color:var(--muted)}
    .location-value{font-weight:700}

    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:8px}
    .btn.gray{background:#fff;color:var(--muted);border:1px solid rgba(15,23,35,0.06)}

    /* Cards grid */
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-top:18px}
    .card{background:var(--card-bg);border-radius:14px;padding:20px;text-align:center;box-shadow:var(--shadow);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:10px}
    .card-logo{width:76px;height:76px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff}
    .title{font-weight:800}
    .desc{color:var(--muted);font-size:14px}

    /* Map & weather */
    .map-container{margin-top:12px;height:260px;border-radius:12px;overflow:hidden;border:1px solid rgba(15,23,35,0.06);background:linear-gradient(180deg,rgba(14,165,164,0.02),rgba(43,157,244,0.01))}
    #map{width:100%;height:100%}

    .weather-glass{display:flex;gap:12px;padding:12px;border-radius:12px;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(255,255,255,0.6));border:1px solid rgba(255,255,255,0.35)}
    .weather-left{width:120px;height:120px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .weather-icon{font-size:40px}
    .weather-temp-big{font-size:26px;font-weight:900}

    .meta-pill{background:rgba(15,23,35,0.03);border-radius:10px;padding:8px 10px;font-weight:700;color:var(--muted);display:inline-flex;gap:8px}

    /* small helpers */
    .small-muted{color:var(--muted)}
    footer.footer{padding:18px;text-align:center;color:var(--muted);margin-top:20px}

    @media(min-width:768px){.weather-glass{min-height:120px}}
  </style>
</head>
<body>
  <!-- Theme / weather indicator (now only shows a weather icon) -->
  <div id="themeIndicator" style="position:fixed;bottom:18px;right:18px;width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.9);box-shadow:0 6px 16px rgba(0,0,0,0.08);font-size:20px;z-index:999">‚òÄÔ∏è</div>

  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon" aria-hidden="true"><svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M12 3L2 12l3 3v6h5v-5h4v5h5v-6l3-3-10-9zm0 9c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg></div>
        <div class="logo-text">Solar Hat</div>
      </div>
      <nav>
        <ul>
          <li><a href="#home">Home</a></li>
          <li><a href="#news">News</a></li>
          <li><a href="#contact">Contact</a></li>
          <li><a href="#about">About</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container">
    <!-- Location -->
    <section class="status-section">
      <div class="status-label">Current Location</div>
      <div class="status-value" id="coords">‚Äî</div>

      <div class="location-row">
        <span class="location-label">Accuracy</span>
        <span class="location-value" id="accuracy">‚Äî</span>
      </div>
      <div class="location-row">
        <span class="location-label">Temperature</span>
        <span class="location-value" id="temperature">‚Äî</span>
      </div>
      <div class="location-row">
        <span class="location-label">Last Updated</span>
        <span class="location-value" id="lastUpdate">‚Äî</span>
      </div>

      <div class="map-container"><div id="map">Map will appear here</div></div>

      <div class="controls">
        <button class="btn" id="locBtn">Get Location</button>
        <button class="btn gray" id="stopLocBtn" style="display:none">Stop</button>
        <button class="btn gray" id="openMapsBtn" style="display:none">Open Maps</button>
        <button class="btn gray" id="muteBtn">Mute</button>
      </div>
    </section>

    <!-- Weather -->
    <section class="status-section" style="margin-top:16px">
      <div class="status-label">Current Weather (Live)</div>
      <div class="weather-glass" id="weatherGlass">
        <div class="weather-left">
          <div id="weatherIcon" class="weather-icon">‚Äî</div>
          <div id="weatherTemp" class="weather-temp-big">‚Äî</div>
          <div class="small-muted" id="weatherSource">‚Äî</div>
        </div>
        <div style="flex:1">
          <div id="weatherCond" style="font-weight:800">‚Äî</div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <div class="meta-pill">Humidity <strong id="weatherHumidity" style="margin-left:6px">‚Äî</strong></div>
            <div class="meta-pill">Wind <strong id="weatherWind" style="margin-left:6px">‚Äî</strong></div>
            <div class="meta-pill">Updated <strong id="weatherExtras" style="margin-left:6px">‚Äî</strong></div>
          </div>
        </div>
      </div>
    </section>

    <div class="cards" role="list" aria-label="Features">
      <a href="location.html" style="text-decoration:none;color:inherit"><article class="card" data-message="You are near the main plaza. Enjoy the panoramic view of the city."><div class="card-logo"><div style="width:44px;height:44px">üìç</div></div><div class="title">Location Guide</div><div class="desc">Nearby points of interest with audio guidance</div></article></a>
      <article class="card" data-message="Rent a Solar Hat for your adventure. Available at multiple locations throughout the city."><div class="card-logo"><div style="width:44px;height:44px">üé©</div></div><div class="title">Rent a Hat</div><div class="desc">Browse and reserve Solar Hats near you</div></article>
      <article class="card" data-message="Solar Hat: Sustainable wearable technology powered by sunlight with location-aware audio."><div class="card-logo"><div style="width:44px;height:44px">‚ÑπÔ∏è</div></div><div class="title">About Us</div><div class="desc">Our vision and innovative technology</div></article>
      <article class="card" data-message="Services include audio tours, navigation assistance, and location-based information."><div class="card-logo"><div style="width:44px;height:44px">üõ†Ô∏è</div></div><div class="title">Services</div><div class="desc">What Solar Hat offers to enhance your experience</div></article>
      <article class="card" data-message="Contact Solar Hat support at support@solarhat.com or call 1-800-SOLAR-HAT."><div class="card-logo"><div style="width:44px;height:44px">‚úâÔ∏è</div></div><div class="title">Contact Support</div><div class="desc">Get in touch with our customer service team</div></article>
      <article class="card" data-message="Our customers love the Solar Hat experience. Read testimonials from satisfied users."><div class="card-logo"><div style="width:44px;height:44px">üåü</div></div><div class="title">Testimonials</div><div class="desc">Customer experiences with Solar Hat</div></article>
    </div>

    <div style="margin-top:18px;padding:12px;background:rgba(14,165,164,0.05);border-radius:10px;color:var(--muted);text-align:center">Tip: Tap any card to hear its message.</div>
  </div>

  <footer class="footer">Developed by Kurdistan Innovators</footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /* ======= Configuration (changed per your request) ======= */
    const UPDATE_INTERVAL = 10 * 60 * 1000; // 10 minutes for weather updates
    const SPEECH_COOLDOWN_MS = 5 * 60 * 1000; // 5 minutes between repeated speech
    const LOCATION_SPEAK_INTERVAL = 5 * 60 * 1000; // speak location at most every 5 min

    /* ---------- shortcuts ---------- */
    const q = s => document.querySelector(s);
    const qa = s => Array.from(document.querySelectorAll(s));

    /* UI elements */
    const locBtn = q('#locBtn'), stopLocBtn = q('#stopLocBtn'), openMapsBtn = q('#openMapsBtn');
    const coordsEl = q('#coords'), accEl = q('#accuracy'), tempEl = q('#temperature'), lastUpdateEl = q('#lastUpdate');
    const wTemp = q('#weatherTemp'), wIcon = q('#weatherIcon'), wCond = q('#weatherCond');
    const wHum = q('#weatherHumidity'), wWind = q('#weatherWind'), wSource = q('#weatherSource'), wExtras = q('#weatherExtras');
    const weatherGlass = q('#weatherGlass');
    const themeIndicator = q('#themeIndicator');

    /* TTS */
    let ttsEnabled = true; const muteBtn = q('#muteBtn');
    const VOICE_RATE = 1.05, VOICE_PITCH = 1, VOICE_VOLUME = 1;
    let lastSpeak = '', lastSpeakTime = 0;

    function updateMuteUI(){ if (!muteBtn) return; muteBtn.textContent = ttsEnabled ? 'Mute' : 'Unmute'; }
    muteBtn?.addEventListener('click', ()=>{ ttsEnabled = !ttsEnabled; if (!ttsEnabled && 'speechSynthesis' in window) speechSynthesis.cancel(); updateMuteUI(); });
    updateMuteUI();

    function speak(text, {force=false} = {}){
      if (!ttsEnabled) return; if (!('speechSynthesis' in window)) return; if (document.visibilityState !== 'visible') return;
      text = String(text).replace(/SolarHat/g,'Solar Hat');
      const now = Date.now();
      if (!force && (text.trim() === lastSpeak.trim()) && (now - lastSpeakTime) < SPEECH_COOLDOWN_MS) return;
      if (!force && (now - lastSpeakTime) < 800) return; // short throttle
      try{
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text); u.rate = VOICE_RATE; u.pitch = VOICE_PITCH; u.volume = VOICE_VOLUME;
        const voices = speechSynthesis.getVoices(); if (voices.length) u.voice = voices.find(v=>v.lang.includes('en')) || voices[0];
        speechSynthesis.speak(u); lastSpeak = text; lastSpeakTime = now;
      }catch(e){console.error(e)}
    }

    speechSynthesis.onvoiceschanged = ()=>{ speak('Welcome to Solar Hat. Tap any card to hear information about that feature.', {force:true}); };

    /* card clicks -> TTS */
    qa('.card').forEach(card => card.addEventListener('click', ()=>{ const msg = card.dataset.message || 'Opening section'; speak(msg); card.animate([{transform:'scale(.98)'},{transform:'scale(1)'}],{duration:220}); }));

    /* Map */
    let map, userMarker, accuracyCircle; const INITIAL_ZOOM = 15;
    function initMap(){ if (map) return; map = L.map('map',{zoomControl:true}).setView([0,0],2); L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap &copy; CARTO'}).addTo(map);} initMap();
    function updateMap(lat,lon,accuracy){ const pt=[lat,lon]; if(!userMarker){ userMarker = L.marker(pt).addTo(map); } else userMarker.setLatLng(pt); if(!accuracyCircle){ accuracyCircle = L.circle(pt,{radius:accuracy, color:'#0ea5a4', fillOpacity:0.12}).addTo(map); } else { accuracyCircle.setLatLng(pt); accuracyCircle.setRadius(accuracy);} map.setView(pt, INITIAL_ZOOM, {animate:true}); }

    /* Geolocation & tracking */
    let watchId = null, updateIntervalId = null; let lastLocationSpoken = {time:0, coords:null, accuracy:null};
    function updateLocationUI(position){ const lat = position.coords.latitude, lon = position.coords.longitude; const latF = lat.toFixed(6), lonF = lon.toFixed(6); const acc = Math.round(position.coords.accuracy || 0);
      coordsEl.textContent = `${latF}, ${lonF}`; accEl.textContent = `${acc} m`; lastUpdateEl.textContent = new Date().toLocaleTimeString();
      accEl.innerHTML = `${acc} m`;
      openMapsBtn.style.display = 'inline-flex'; stopLocBtn.style.display = 'inline-flex';
      if (acc <= 30) accEl.style.color = 'green'; else if (acc <= 100) accEl.style.color = 'orange'; else accEl.style.color = 'red';
      try{ updateMap(lat,lon,acc); }catch(e){console.error(e)}

      // Speak location occasionally (every LOCATION_SPEAK_INTERVAL)
      const now = Date.now();
      const moved = lastLocationSpoken.coords ? (Math.hypot(lat-lastLocationSpoken.coords.lat, lon-lastLocationSpoken.coords.lon)*111000 > 50) : true;
      if (moved || (now - lastLocationSpoken.time) > LOCATION_SPEAK_INTERVAL || (acc < (lastLocationSpoken.accuracy || 9999)-20)){
        speak(`Location acquired. Accuracy within ${acc} meters.`); lastLocationSpoken = {time:now, coords:{lat,lon}, accuracy:acc};
      }

      // update weather for this location (and set periodic updates)
      fetchOpenMeteoWeather(lat,lon);
      if (updateIntervalId) clearInterval(updateIntervalId);
      updateIntervalId = setInterval(()=>fetchOpenMeteoWeather(lat,lon), UPDATE_INTERVAL);
    }

    function startWatch(){ if (!('geolocation' in navigator)) { speak('Geolocation not supported'); return; } if (watchId !== null) return; locBtn.disabled = true; locBtn.textContent = 'Locating...';
      watchId = navigator.geolocation.watchPosition(pos=>{ updateLocationUI(pos); locBtn.disabled=false; locBtn.textContent='Get Location'; }, err=>{ console.error(err); speak('Location error'); locBtn.disabled=false; locBtn.textContent='Get Location'; if (watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; } }, {enableHighAccuracy:true,timeout:10000,maximumAge:0}); }
    function stopWatch(){ if (watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; stopLocBtn.style.display='none'; speak('Location tracking stopped'); } if (updateIntervalId){ clearInterval(updateIntervalId); updateIntervalId=null; } }
    locBtn?.addEventListener('click', startWatch); stopLocBtn?.addEventListener('click', stopWatch); openMapsBtn?.addEventListener('click', ()=>{ const txt = coordsEl.textContent; if (!txt||txt==='‚Äî') return; const [lat,lon] = txt.split(',').map(s=>s.trim()); window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`,'_blank'); });

    /* Weather (Open-Meteo) */
    const weatherCodeMap = {0:['Clear sky','‚òÄÔ∏è'],1:['Mainly clear','üå§Ô∏è'],2:['Partly cloudy','‚õÖ'],3:['Overcast','‚òÅÔ∏è'],45:['Fog','üå´Ô∏è'],48:['Rime fog','üå´Ô∏è'],51:['Light drizzle','üå¶Ô∏è'],53:['Moderate drizzle','üåßÔ∏è'],55:['Dense drizzle','üåßÔ∏è'],61:['Slight rain','üåßÔ∏è'],63:['Moderate rain','üåßÔ∏è'],65:['Heavy rain','üåßÔ∏è'],71:['Slight snow','‚ùÑÔ∏è'],73:['Moderate snow','‚ùÑÔ∏è'],75:['Heavy snow','‚ùÑÔ∏è'],80:['Rain showers','üå¶Ô∏è'],95:['Thunderstorm','‚õàÔ∏è']};

    async function fetchOpenMeteoWeather(lat,lon){ try{
        const ep = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current_weather=true&hourly=relativehumidity_2m&timezone=auto`;
        wSource.textContent = 'Open-Meteo'; wIcon.textContent = '‚è≥'; wTemp.textContent='‚Äî'; wCond.textContent='Loading...';
        const resp = await fetch(ep,{cache:'no-store'}); if(!resp.ok) throw new Error('Failed'); const data = await resp.json(); if(!data||!data.current_weather) throw new Error('No data');
        const cw = data.current_weather; const temperature = Number(cw.temperature); const wind = Number(cw.windspeed); const code = Number(cw.weathercode);
        let humidity = '‚Äî'; if (data.hourly && data.hourly.time && data.hourly.relativehumidity_2m){ const times = data.hourly.time, rh = data.hourly.relativehumidity_2m; let bestIdx=0, bestDiff=Infinity; for(let i=0;i<times.length;i++){ const t=new Date(times[i]); const diff = Math.abs(t - new Date()); if(diff<bestDiff){bestIdx=i;bestDiff=diff}} humidity = (typeof rh[bestIdx] !== 'undefined')? `${Math.round(rh[bestIdx])}%` : '‚Äî'; }
        const mapVal = weatherCodeMap[code] || ['Clear','‚òÄÔ∏è']; const conditionText = mapVal[0], conditionIcon = mapVal[1];
        const weather = { temperatureC: temperature, humidity: humidity, windKmh: `${wind} km/h`, condition: conditionText, icon: conditionIcon };
        applyWeather(weather,'Open-Meteo');

        // speak weather occasionally
        const now = Date.now(); const tempChanged = Math.abs(temperature - (window.__lastWeatherTemp||0)) > 2; const condChanged = (conditionText !== (window.__lastWeatherCond||''));
        if (tempChanged || condChanged || (now - (window.__lastWeatherTime||0)) > UPDATE_INTERVAL){ speak(`Current temperature is ${temperature.toFixed(1)} degrees Celsius and ${conditionText}`, {force:true}); window.__lastWeatherTemp = temperature; window.__lastWeatherCond = conditionText; window.__lastWeatherTime = now; }
        return true;
      }catch(err){ console.warn('Weather failed',err); wSource.textContent='Unavailable'; wIcon.textContent='‚ö†Ô∏è'; wCond.textContent='Service unavailable'; wTemp.textContent='‚Äî'; return false; }
    }

    function applyWeather(w, source=''){ if (wTemp) wTemp.textContent = `${Number(w.temperatureC).toFixed(1)}¬∞C`; if (wIcon) wIcon.textContent = w.icon||'‚Äî'; if (wCond) wCond.textContent = w.condition||'‚Äî'; if (wHum) wHum.textContent = w.humidity||'‚Äî'; if (wWind) wWind.textContent = w.windKmh||'‚Äî'; if (wSource) wSource.textContent = source||'‚Äî'; if (wExtras) wExtras.textContent = `Updated ${new Date().toLocaleTimeString()}`;
      // show simple indicator (sun/moon) ‚Äî choose icon from the weather emoji if possible
      try{ themeIndicator.textContent = w.icon && typeof w.icon === 'string' ? w.icon : '‚òÄÔ∏è'; themeIndicator.title = w.condition || 'Weather'; }catch(e){}
    }

    /* fallback simulated weather */
    function simulateWeatherFor(lat,lon){ const seed = Math.abs(Math.floor((lat*10000) ^ (lon*10000))); function rnd(min,max){ const x = Math.sin(seed + min*9973 + max*7919) * 43758.5453; const n = Math.abs(x - Math.floor(x)); return min + n*(max-min); }
      const latAbs = Math.abs(lat); const base = 28 - (latAbs/90)*40; const t = base + rnd(-4,4); const humidity = Math.max(8,Math.min(95,Math.round(50 + rnd(-28,28)))); const wind = Math.max(0, +(rnd(0,22)).toFixed(1)); const r = rnd(0,100);
      let cond = 'Partly cloudy'; if (r < 10 && t < 2) cond = 'Snow'; else if (r < 25 && t < 15) cond = 'Light rain'; else if (r < 55) cond = (t > 25 ? 'Sunny' : 'Partly cloudy'); else cond = 'Cloudy'; const icon = cond.toLowerCase().includes('snow') ? '‚ùÑÔ∏è' : cond.toLowerCase().includes('rain') ? 'üåßÔ∏è' : cond.toLowerCase().includes('cloud') ? '‚òÅÔ∏è' : '‚òÄÔ∏è';
      return { temperatureC: Number(t.toFixed(1)), humidity: `${humidity}%`, windKmh: `${wind} km/h`, condition: cond, icon };
    }

    // On load: try quick location & weather
    (function init(){ if ('geolocation' in navigator){ navigator.geolocation.getCurrentPosition(pos=>{ try{ updateLocationUI(pos); }catch(e){} }, ()=>{}, {enableHighAccuracy:true,maximumAge:60000,timeout:6000}); }
      // If no weather yet, simulate a fallback so UI isn't empty
      setTimeout(()=>{ if (!wTemp || wTemp.textContent === '‚Äî'){ const s = simulateWeatherFor(0,0); applyWeather(s,'Simulated'); } }, 500);
    })();

    // stop tts when hidden
    document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState === 'hidden') { speechSynthesis.cancel(); } });
  </script>
</body>
</html>
