<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SecureHat â€” Private Location Sharing & Chat (Test)</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    *{box-sizing:border-box;margin:0;padding:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{min-height:100vh;background:linear-gradient(135deg,#10203a,#13294f);color:#fff;padding:24px}
    .container{max-width:980px;margin:0 auto}

    header{text-align:center;margin-bottom:18px}
    .logo{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:6px}
    .logo-icon{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(45deg,#ff7e5f,#feb47b);box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .logo-text{font-weight:800;font-size:1.6rem;background:linear-gradient(90deg,#ff7e5f,#feb47b);-webkit-background-clip:text;color:transparent}
    h1{font-size:1.6rem;margin-bottom:6px}
    .subtitle{opacity:.9;font-size:0.98rem}

    .privacy-notice{background:rgba(255,255,255,.05);padding:12px;border-radius:10px;border-left:4px solid #4cd137;margin:14px 0;display:flex;align-items:center;gap:10px}
    .card{background:rgba(255,255,255,.04);padding:18px;border-radius:12px;margin:12px 0;border:1px solid rgba(255,255,255,.06)}
    .card-title{display:flex;align-items:center;gap:10px;color:#feb47b;font-weight:700;margin-bottom:12px}

    .form-group{margin-bottom:14px}
    .form-label{display:block;font-weight:700;margin-bottom:6px}
    .form-note{font-size:.85rem;opacity:.85;margin-top:6px}
    .form-control{width:100%;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,.04);color:#fff;font-size:1rem}
    .form-control:focus{outline:2px solid rgba(255,126,95,.4);background:rgba(255,255,255,.06)}

    .btn-container{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.btn-container{grid-template-columns:1fr}}
    .btn{padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:linear-gradient(45deg,#ff7e5f,#feb47b);color:#fff;display:inline-flex;align-items:center;gap:8px;justify-content:center}
    .btn-outline{background:transparent;border:2px solid #ff7e5f;color:#ff7e5f}
    .btn-stop{background:linear-gradient(45deg,#e84118,#c23616);color:#fff}
    .small-btn{padding:8px 10px;font-size:.92rem;border-radius:8px}

    .code-row{display:flex;gap:10px;align-items:center;margin-top:10px}
    .code-input{flex:1;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,.03);text-align:center;letter-spacing:3px;font-weight:700;color:#fff}
    .code-meta{font-size:.85rem;color:rgba(255,255,255,.8);margin-top:6px}

    .map-container{height:320px;border-radius:12px;overflow:hidden;margin-top:14px;border:2px solid rgba(255,255,255,.04)}
    #map{width:100%;height:100%}

    .user-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:14px}
    .user-card{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.03)}
    .user-avatar{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(45deg,#4facfe,#00f2fe);font-weight:800}
    .user-info .user-name{font-weight:700}
    .status-dot{width:10px;height:10px;border-radius:50%;background:#4cd137;display:inline-block;margin-right:8px}

    .chat-card{display:flex;flex-direction:column;height:280px}
    .chat-messages{flex:1;overflow:auto;padding:10px;border-radius:8px;background:rgba(0,0,0,0.12);margin-bottom:8px}
    .chat-input-row{display:flex;gap:8px}
    .chat-input{flex:1;padding:10px;border-radius:8px;border:none}
    .chat-send{padding:10px;border-radius:8px;border:none;background:linear-gradient(45deg,#4facfe,#00f2fe);color:#fff;cursor:pointer}

    .notification{position:fixed;right:18px;top:18px;background:rgba(0,0,0,.45);padding:12px 16px;border-radius:10px;backdrop-filter:blur(4px);transform:translateX(120%);transition:transform .32s;z-index:9000;color:#fff;border-left:4px solid #4cd137}
    .notification.show{transform:translateX(0)}
    .notification.error{border-left-color:#e84118}

    footer{text-align:center;margin-top:18px;font-size:0.9rem;opacity:.8}

    /* Modal (join) */
    #join-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:10000;pointer-events:none}
    #join-modal.show{display:flex;pointer-events:auto}
    .join-box{width:90%;max-width:480px;background:linear-gradient(135deg,#0e2340,#102e4a);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,.06)}

    /* Stop confirmation modal */
    #stop-confirmation{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.72);z-index:9999;pointer-events:none}
    #stop-confirmation.show{display:flex;pointer-events:auto}
    .confirmation-box{width:90%;max-width:520px;background:linear-gradient(135deg,#11264a,#183054);border-radius:12px;padding:22px;border:1px solid rgba(255,255,255,.06);box-shadow:0 18px 40px rgba(0,0,0,.6);text-align:center;pointer-events:auto}
    .confirmation-buttons{display:flex;gap:12px;justify-content:center;margin-top:16px}
    .hidden{display:none !important}
    .muted{opacity:.9;font-size:.92rem}
    .message-me{align-self:flex-end;background:linear-gradient(45deg,#ff7e5f,#feb47b);color:#000;padding:8px 12px;border-radius:12px;margin:6px 0;max-width:70%}
    .message-peer{align-self:flex-start;background:rgba(255,255,255,0.08);color:#fff;padding:8px 12px;border-radius:12px;margin:6px 0;max-width:70%}
</style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo">
            <div class="logo-icon"><i class="fas fa-user-secret" style="font-size:20px"></i></div>
            <div>
                <div class="logo-text">SECUREHAT</div>
                <div style="font-size:0.9rem;color:rgba(255,255,255,0.85);font-weight:600;margin-top:4px;">
                    Private Location Sharing &amp; Chat
                </div>
                <div style="font-size:0.85rem;color:rgba(255,255,255,0.65);margin-top:6px;">
                    <em>Developed by Kurdistan Innovator Team</em>
                </div>
            </div>
        </div>
        <h1>Private Location Sharing & Chat (Test)</h1>
        <div class="subtitle muted">Your real name stays local-only. Session persists until you press STOP.</div>
    </header>

    <div class="privacy-notice">
        <i class="fas fa-shield-alt" style="color:#4cd137"></i>
        <div><strong>Privacy Notice:</strong> Your real name is stored locally only and is never shared with others or logs.</div>
    </div>

    <!-- Setup -->
    <div class="card" id="setup-card">
        <div class="card-title"><i class="fas fa-user"></i> User Setup</div>

        <div class="form-group">
            <label class="form-label">Your Real Name (Local Only)</label>
            <input id="real-name" class="form-control" type="text" placeholder="Type your real name (required)">
            <div class="form-note">You must type your name each time you start/resume a session. It will be stored locally only and never transmitted.</div>
        </div>

        <div class="form-group">
            <label class="form-label">Session Code</label>
            <div class="code-row">
                <input id="session-code" class="code-input" type="text" placeholder="Enter or generate a secure code">
                <button id="gen-code" class="btn small-btn" title="Generate a secure, hard-to-guess code"><i class="fas fa-lock"></i> Generate</button>
                <button id="reveal-code" class="btn btn-outline small-btn" title="Reveal/Hide generated code">Reveal</button>
            </div>
            <div class="code-meta">
                <span id="code-hint">Tip: generate a secure code to reduce guessing. Reveal shows it briefly and enables copy.</span>
                <button id="copy-session-code" class="btn btn-outline small-btn" style="margin-left:12px;">Copy</button>
            </div>
        </div>

        <div class="btn-container">
            <button id="create-session" class="btn"><i class="fas fa-plus-circle"></i> Create Session</button>
            <button id="open-join" class="btn btn-outline"><i class="fas fa-user-friends"></i> Join Session</button>
        </div>
    </div>

    <!-- Active session card -->
    <div class="card hidden" id="session-card">
        <div class="card-title"><i class="fas fa-satellite"></i> Active Session</div>

        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
            <div style="background:rgba(255,255,255,.04);padding:8px;border-radius:999px;display:flex;align-items:center;gap:8px;">
                <span id="connection-dot" style="width:12px;height:12px;border-radius:50%;display:inline-block;background:#fbc531"></span>
                <div id="status-text">Ready to connect</div>
            </div>
            <div style="margin-left:auto">
                <span class="muted">Peers:</span> <span id="peer-count">0</span>
            </div>
        </div>

        <div class="code-container">
            <input id="display-code" class="code-input" readonly placeholder="Session Code">
            <button id="copy-code" class="btn btn-outline" title="Copy code"><i class="fas fa-copy"></i></button>
        </div>

        <div class="btn-container" style="margin-top:12px;grid-template-columns:1fr 1fr 1fr">
            <button id="resume-session" class="btn btn-outline"><i class="fas fa-play"></i> Resume</button>
            <button id="share-location" class="btn"><i class="fas fa-location-dot"></i> Share My Location</button>
            <button id="stop-session" class="btn btn-stop"><i class="fas fa-power-off"></i> Stop Session</button>
        </div>

        <div class="form-note" style="margin-top:10px">Note: you must re-type your real name to resume (local-only).</div>
    </div>

    <!-- Map -->
    <div class="card">
        <div class="card-title"><i class="fas fa-map-marked-alt"></i> Location Map</div>
        <div class="map-container"><div id="map"></div></div>
    </div>

    <!-- Connected users + chat -->
    <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="card-title"><i class="fas fa-users"></i> Connected Users</div>
            <div class="muted">Chat & messages are anonymized</div>
        </div>

        <div class="user-list" id="user-list">
            <div class="user-card" id="you-card">
                <div class="user-avatar">Y</div>
                <div class="user-info">
                    <div class="user-name">You</div>
                    <div class="user-location muted"><i class="fas fa-location-slash"></i> Location not shared</div>
                    <div style="margin-top:8px"><span class="status-dot"></span> Online</div>
                </div>
            </div>
        </div>

        <div style="margin-top:12px" class="chat-card">
            <div class="chat-messages" id="chat-messages" aria-live="polite"></div>
            <div class="chat-input-row" style="margin-top:8px">
                <input id="chat-input" class="chat-input" placeholder="Type a message (anonymous)..." />
                <button id="chat-send" class="chat-send"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <footer>
      <div>SecureHat Â© test â€” Privacy First | No DB | Session persists until stopped</div>
      <div style="margin-top:6px;font-size:0.85rem;opacity:0.85;">
        Built and maintained by <strong>Kurdistan Innovator Team</strong>
      </div>
    </footer>
</div>

<!-- Notification -->
<div id="notification" class="notification" role="status" aria-live="polite"><i class="fas fa-info-circle"></i> <span id="notification-message">Ready</span></div>

<!-- Join modal -->
<div id="join-modal" aria-hidden="true">
  <div class="join-box">
    <h3 style="margin:0 0 8px"><i class="fas fa-user-friends"></i> Join Session</h3>
    <p class="muted" style="margin:0 0 12px">Enter the session code provided by the host.</p>
    <input id="join-code-input" class="form-control" placeholder="Enter join session code">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="join-cancel" class="btn btn-outline">Cancel</button>
      <button id="join-now" class="btn"><i class="fas fa-sign-in-alt"></i> Join Now</button>
    </div>
  </div>
</div>

<!-- Stop confirmation modal -->
<div id="stop-confirmation" role="dialog" aria-modal="true" aria-labelledby="stop-title">
    <div class="confirmation-box">
        <h3 id="stop-title"><i class="fas fa-exclamation-triangle" style="color:#ffb86b"></i> Confirm Session Stop</h3>
        <p style="margin-top:8px">Are you sure you want to stop the current session? This will end the session (test-only).</p>
        <div class="confirmation-buttons">
            <button id="confirm-stop" class="btn btn-stop"><i class="fas fa-check"></i> Yes, Stop Session</button>
            <button id="cancel-stop" class="btn btn-outline"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </div>
</div>

<script>
/* ========= DOM refs ========= */
const realNameInput = document.getElementById('real-name');
const sessionCodeInput = document.getElementById('session-code');
const genCodeBtn = document.getElementById('gen-code');
const revealCodeBtn = document.getElementById('reveal-code');
const copySessionCodeBtn = document.getElementById('copy-session-code');

const createSessionBtn = document.getElementById('create-session');
const openJoinBtn = document.getElementById('open-join');
const joinModal = document.getElementById('join-modal');
const joinCodeInput = document.getElementById('join-code-input');
const joinNowBtn = document.getElementById('join-now');
const joinCancelBtn = document.getElementById('join-cancel');

const setupCard = document.getElementById('setup-card');
const sessionCard = document.getElementById('session-card');
const displayCodeInput = document.getElementById('display-code');
const copyCodeBtn = document.getElementById('copy-code');
const shareLocationBtn = document.getElementById('share-location');
const stopSessionBtn = document.getElementById('stop-session');
const resumeSessionBtn = document.getElementById('resume-session');
const statusText = document.getElementById('status-text');
const peerCount = document.getElementById('peer-count');
const connectionDot = document.getElementById('connection-dot');
const notification = document.getElementById('notification');
const notificationMessage = document.getElementById('notification-message');
const userList = document.getElementById('user-list');
const stopConfirmation = document.getElementById('stop-confirmation');
const confirmStopBtn = document.getElementById('confirm-stop');
const cancelStopBtn = document.getElementById('cancel-stop');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
const codeHint = document.getElementById('code-hint');

/* ========= State ========= */
let peer = null;
let conn = null;
let myAlias = generateAnonAlias();
let myMarker = null;
let peerMarker = null;
let notificationTimeout = null;
let sessionRoleCached = null;

let codeRevealed = false; // reveal state for generated codes
let autoHideTimeout = null;
let sessionTimeout = null; // For session expiration

/* ========= Map init ========= */
const map = L.map('map', { 
    attributionControl: false,
    center: [34.5, 45.5], // Kurdistan approximate center
    zoom: 7
});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

/* ========= Helpers ========= */
function generateAnonAlias(){ return 'User-' + Math.random().toString(36).slice(2,6).toUpperCase(); }

function showNotification(msg, isError=false, duration=3000){
    if(notificationTimeout){ clearTimeout(notificationTimeout); notificationTimeout=null; }
    notificationMessage.textContent = msg;
    notification.classList.add('show');
    if(isError) notification.classList.add('error'); else notification.classList.remove('error');
    notificationTimeout = setTimeout(()=>{ notification.classList.remove('show'); notification.classList.remove('error'); }, duration);
}

function updateStatus(text, connected=false){
    statusText.textContent = text;
    connectionDot.style.background = connected ? '#4cd137' : '#fbc531';
}

function updatePeerCount(n){
    peerCount.textContent = String(n);
}

function safeSend(payload){
    if(!conn || conn.open === false) return;
    if(payload && typeof payload === 'object'){
        delete payload.local_real_name;
        delete payload.realName;
        delete payload.name;
    }
    try { conn.send(payload); } catch(e){ console.error('send failed', e); showNotification('Send failed', true); }
}

function destroyExistingPeer(){
    if(conn){ try{ conn.close(); }catch(e){} conn=null; }
    if(peer){ try{ peer.destroy(); }catch(e){} peer=null; }
}

/* copy helper modern */
async function copyToClipboard(text){
    try {
        if(navigator.clipboard && window.isSecureContext){
            await navigator.clipboard.writeText(text);
        } else {
            const ta = document.createElement('textarea'); ta.value=text;
            ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        }
        showNotification('Code copied to clipboard');
    } catch(e){ console.error(e); showNotification('Copy failed', true); }
}

/* append chat message */
function appendMessage(text, fromMe=false){
    const el = document.createElement('div');
    el.className = fromMe ? 'message-me' : 'message-peer';
    el.textContent = text;
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

/* ========= Code generator & reveal logic ========= */

/*
  Generate a secure, hard-to-guess session code using crypto.getRandomValues.
  Output is base62-ish: A-Z a-z 0-9, length configurable.
*/
function generateSecureCode(length = 8) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const arr = new Uint8Array(length);
    window.crypto.getRandomValues(arr);
    let s = '';
    for (let i = 0; i < arr.length; i++) {
        s += alphabet[arr[i] % alphabet.length];
    }
    return s;
}

genCodeBtn.addEventListener('click', () => {
    const code = generateSecureCode(8);
    sessionCodeInput.value = code;
    // mask by default (so user must reveal to copy)
    maskCodeDisplay();
    showNotification('Secure code generated. Click Reveal to view and copy.');
});

function maskCodeDisplay() {
    codeRevealed = false;
    sessionCodeInput.type = 'password';
    sessionCodeInput.style.letterSpacing = 'normal';
    revealCodeBtn.textContent = 'Reveal';
    copySessionCodeBtn.disabled = true;
    // auto-clear previous auto-hide timer
    if (autoHideTimeout) { clearTimeout(autoHideTimeout); autoHideTimeout = null; }
}

function revealCodeTemporarily() {
    if (!sessionCodeInput.value) {
        showNotification('No code to reveal', true);
        return;
    }
    codeRevealed = true;
    sessionCodeInput.type = 'text';
    sessionCodeInput.style.letterSpacing = '3px';
    revealCodeBtn.textContent = 'Hide';
    copySessionCodeBtn.disabled = false;
    // auto-hide after 20 seconds to reduce easy copying
    if (autoHideTimeout) clearTimeout(autoHideTimeout);
    autoHideTimeout = setTimeout(() => {
        maskCodeDisplay();
        showNotification('Code auto-hidden for security');
    }, 20000);
}

revealCodeBtn.addEventListener('click', () => {
    if (codeRevealed) {
        maskCodeDisplay();
    } else {
        revealCodeTemporarily();
    }
});

// copy session code button (near generator)
copySessionCodeBtn.addEventListener('click', () => {
    if (!sessionCodeInput.value) { showNotification('No code to copy', true); return; }
    if (!codeRevealed) { showNotification('Reveal the code first to enable copying', true); return; }
    copyToClipboard(sessionCodeInput.value);
});

/* ========= Join modal behavior ========= */

openJoinBtn.addEventListener('click', () => {
    joinModal.classList.add('show');
    joinModal.setAttribute('aria-hidden', 'false');
    joinCodeInput.value = '';
    setTimeout(()=> joinCodeInput.focus(), 60);
});

joinCancelBtn.addEventListener('click', () => {
    joinModal.classList.remove('show');
    joinModal.setAttribute('aria-hidden', 'true');
});

joinNowBtn.addEventListener('click', () => {
    const code = (joinCodeInput.value || '').trim();
    if (!code || code.length < 4) {
        showNotification('Enter a valid join code (min 4 chars)', true);
        return;
    }
    // place the join code into the main session-code input (masked by default)
    sessionCodeInput.value = code;
    maskCodeDisplay();
    // hide modal
    joinModal.classList.remove('show');
    joinModal.setAttribute('aria-hidden', 'true');
    // start join flow (requires user to type their name first)
    if (!realNameInput.value.trim()) {
        showNotification('Type your real name (local only) before joining.', true);
        // show setup card so user can type name
        setupCard.classList.remove('hidden');
        sessionCard.classList.add('hidden');
        return;
    }
    startSession(false);
});

// close modal when clicking outside join-box
joinModal.addEventListener('click', (e) => {
    if (e.target === joinModal) {
        joinModal.classList.remove('show');
        joinModal.setAttribute('aria-hidden', 'true');
    }
});

/* ========= Create / Join fixes (existing logic, updated to require code) ========= */

function startSession(isHost){
    const code = (sessionCodeInput.value || '').trim();
    const realName = (realNameInput.value || '').trim();

    // require name typed each time
    if(!realName){
        showNotification('Type your real name (local only) to proceed', true); return;
    }
    if(code.length < 4){ showNotification('Enter a valid code (min 4 chars)', true); return; }

    // prevent creating new session if already active locally
    if(localStorage.getItem('session_active') === 'true' && isHost){
        showNotification('A session is already active locally. Stop it first or Resume.', true);
        return;
    }

    // persist local-only name & session flags
    localStorage.setItem('local_real_name', realName);
    localStorage.setItem('session_code', code);
    localStorage.setItem('session_active', 'true');
    localStorage.setItem('session_role', isHost ? 'host' : 'joiner');
    sessionRoleCached = isHost ? 'host' : 'joiner';

    // UI update
    setupCard.classList.add('hidden');
    sessionCard.classList.remove('hidden');
    displayCodeInput.value = code;
    updateStatus('Connecting...', false);
    updatePeerCount(0);

    // cleanup old peer
    destroyExistingPeer();

    // create Peer
    try {
        peer = isHost ? new Peer(code) : new Peer();
    } catch(e){ console.error('Peer create failed', e); showNotification('Peer init failed', true); updateStatus('Error', false); return; }

    setControlsDisabled(true);

    // Set session timeout (30 minutes)
    if(sessionTimeout) clearTimeout(sessionTimeout);
    sessionTimeout = setTimeout(() => {
        showNotification('Session expired after 30 minutes', true);
        stopSession();
    }, 30 * 60 * 1000);

    let joinAttempts = 0;
    const MAX_JOIN_ATTEMPTS = 6;
    const JOIN_INTERVAL_MS = 1400;

    peer.on('open', (id) => {
        if(!isHost){
            // attempt connect with retry loop
            function tryConnect(){
                joinAttempts++;
                try {
                    conn = peer.connect(code, { reliable: true, serialization: 'json' });
                } catch(err){
                    console.warn('connect exception', err);
                    conn = null;
                }
                if(conn){
                    conn.on('open', () => {
                        updateStatus('Connected to host', true);
                        updatePeerCount(1);
                        showNotification('Connected to host');
                        safeSend({ type:'alias', alias: myAlias });
                    });
                    conn.on('error', (err) => { console.error('conn error', err); showNotification('Connection error', true); });
                    setupDataChannel(conn);
                } else {
                    if(joinAttempts < MAX_JOIN_ATTEMPTS){
                        updateStatus(`Trying to connect... (${joinAttempts}/${MAX_JOIN_ATTEMPTS})`, false);
                        setTimeout(tryConnect, JOIN_INTERVAL_MS);
                    } else {
                        showNotification('Unable to connect to host (no host found).', true);
                        updateStatus('Unable to connect', false);
                        setControlsDisabled(false);
                    }
                }
            }
            // start first try
            tryConnect();
        } else {
            updateStatus('Hosting â€” waiting for peers', true);
            showNotification('Hosting session â€” share the code (reveal briefly to copy).');
            setControlsDisabled(false);
        }
    });

    peer.on('connection', (connection) => {
        // host receives incoming connection
        conn = connection;
        setupDataChannel(conn);
        updateStatus('Peer connected', true);
        updatePeerCount(1);
        showNotification('Peer connected');
        safeSend({ type:'alias', alias: myAlias });
    });

    peer.on('disconnected', () => { updateStatus('Disconnected', false); showNotification('Network disconnected', true); setControlsDisabled(false); });
    peer.on('close', () => { updateStatus('Closed', false); setControlsDisabled(false); });
    peer.on('error', (err) => { console.error('peer error', err); showNotification('Peer error: ' + String(err), true); updateStatus('Error', false); setControlsDisabled(false); });
}

function setupDataChannel(connection){
    if(!connection) return;
    connection.on('data', (data) => {
        // defensive: remove any name fields
        if(data && typeof data === 'object'){ delete data.local_real_name; delete data.realName; delete data.name; }

        if(data.type === 'alias') updatePeerAlias(data);
        else if(data.type === 'location') updatePeerLocation(data);
        else if(data.type === 'chat') {
            const txt = (data && data.text) ? String(data.text) : '';
            appendMessage((data.clientAlias ? data.clientAlias + ': ' : '') + txt, false);
        }
    });

    connection.on('close', () => {
        updateStatus('Peer disconnected', false);
        updatePeerCount(0);
        if(peerMarker){ map.removeLayer(peerMarker); peerMarker=null; }
        showNotification('Peer disconnected');
    });

    connection.on('error', (err) => { console.error('data channel error', err); showNotification('Data channel error', true); });
}

function updatePeerAlias(data){
    const alias = (data && data.alias) ? String(data.alias) : generateAnonAlias();
    // prevent duplicate
    const existing = Array.from(userList.querySelectorAll('.user-name')).some(el => el.textContent === alias);
    if(existing) return;
    const div = document.createElement('div'); div.className='user-card';
    div.innerHTML = `<div class="user-avatar">${alias.charAt(0)}</div><div class="user-info"><div class="user-name">${alias}</div><div class="user-location muted"><i class="fas fa-location-dot"></i> Location shared</div><div style="margin-top:8px"><span class="status-dot"></span> Online</div></div>`;
    const youCard = document.getElementById('you-card');
    userList.insertBefore(div, youCard.nextSibling);
}

function updatePeerLocation(d){
    const latitude = Number(d.latitude), longitude = Number(d.longitude);
    if(isNaN(latitude) || isNaN(longitude)) return;
    if(peerMarker) map.removeLayer(peerMarker);
    peerMarker = L.marker([latitude, longitude]).addTo(map).bindPopup('<b>Peer Location</b>').openPopup();
    if(!myMarker) map.setView([latitude, longitude], 13);
}

/* share location */
function shareMyLocation(){
    // Allow location sharing even if connection is temporarily lost
    if(!peer) {
        showNotification('No active session. Create or join a session first.', true);
        return;
    }
    
    if(!navigator.geolocation){ showNotification('Geolocation not supported', true); return; }

    shareLocationBtn.disabled = true;
    shareLocationBtn.innerHTML = `<i class="fas fa-sync fa-spin"></i> Getting...`;

    navigator.geolocation.getCurrentPosition(pos => {
        const latitude = pos.coords.latitude, longitude = pos.coords.longitude;
        const myCard = document.getElementById('you-card');
        myCard.querySelector('.user-location').innerHTML = `<i class="fas fa-location-dot"></i> Location shared`;
        if(myMarker) map.removeLayer(myMarker);
        myMarker = L.marker([latitude, longitude]).addTo(map).bindPopup('<b>Your Location</b>').openPopup();
        map.setView([latitude, longitude], 13);

        // Try to send even if connection might be temporarily down
        if(conn && conn.open) {
            safeSend({ type:'location', latitude: latitude, longitude: longitude, clientAlias: myAlias });
        }

        shareLocationBtn.disabled = false;
        shareLocationBtn.innerHTML = `<i class="fas fa-location-dot"></i> Share My Location`;
        showNotification('Location shared');
    }, err => {
        console.error('Geolocation error', err);
        shareLocationBtn.disabled = false;
        shareLocationBtn.innerHTML = `<i class="fas fa-location-dot"></i> Share My Location`;
        showNotification('Could not get location (enable location services)', true);
    }, { enableHighAccuracy:true, maximumAge:30000, timeout:10000 });
}

/* stop session */
function stopSession(){
    destroyExistingPeer();
    localStorage.removeItem('session_active');
    localStorage.removeItem('session_role');
    localStorage.removeItem('session_code');
    sessionRoleCached = null;

    setupCard.classList.remove('hidden');
    sessionCard.classList.add('hidden');
    displayCodeInput.value = '';
    updateStatus('Ready to connect', false);
    updatePeerCount(0);

    if(myMarker){ map.removeLayer(myMarker); myMarker=null; }
    if(peerMarker){ map.removeLayer(peerMarker); peerMarker=null; }

    userList.innerHTML = `<div class="user-card" id="you-card"><div class="user-avatar">Y</div><div class="user-info"><div class="user-name">You</div><div class="user-location muted"><i class="fas fa-location-slash"></i> Location not shared</div><div style="margin-top:8px"><span class="status-dot"></span> Online</div></div></div>`;

    chatMessages.innerHTML = '';
    
    // Clear session timeout
    if(sessionTimeout) clearTimeout(sessionTimeout);
    
    showNotification('Session stopped (test-only)');
}

/* control helper */
function setControlsDisabled(state){
    [createSessionBtn, openJoinBtn, resumeSessionBtn, copyCodeBtn].forEach(b => { if(b) b.disabled = state; });
}

/* ========= Modal fixed behavior (stop modal) ========= */
function showStopModal(){
    const sessionActive = localStorage.getItem('session_active') === 'true';
    if(!sessionActive){ showNotification('No active session to stop', true); return; }
    stopConfirmation.classList.add('show');
    confirmStopBtn.focus();
}
function hideStopModal(){ stopConfirmation.classList.remove('show'); }

stopSessionBtn.addEventListener('click', (e) => { showStopModal(); });
confirmStopBtn.addEventListener('click', (e) => { hideStopModal(); setTimeout(()=> stopSession(), 120); });
cancelStopBtn.addEventListener('click', hideStopModal);
stopConfirmation.addEventListener('click', (e) => { if(e.target === stopConfirmation) hideStopModal(); });
const confirmationBox = stopConfirmation.querySelector('.confirmation-box');
if(confirmationBox) confirmationBox.addEventListener('click', (e)=> e.stopPropagation());
window.addEventListener('keydown', (e) => { if(e.key === 'Escape' && stopConfirmation.classList.contains('show')) hideStopModal(); });

/* ========= Resume & load handling ========= */
window.addEventListener('DOMContentLoaded', () => {
    // intentionally DO NOT auto-fill the real name
    const sessionCode = localStorage.getItem('session_code');
    const sessionActive = localStorage.getItem('session_active') === 'true';
    const sessionRole = localStorage.getItem('session_role');

    if(sessionCode && sessionActive && sessionRole){
        displayCodeInput.value = sessionCode;
        setupCard.classList.remove('hidden');
        sessionCard.classList.remove('hidden');
        updateStatus('Session active (server-side). Type your name and press Resume.', false);
        updatePeerCount(0);
        sessionRoleCached = sessionRole;
        
        // Set session timeout (30 minutes) if session is active
        if(sessionTimeout) clearTimeout(sessionTimeout);
        sessionTimeout = setTimeout(() => {
            showNotification('Session expired after 30 minutes', true);
            stopSession();
        }, 30 * 60 * 1000);
    } else {
        setupCard.classList.remove('hidden');
        sessionCard.classList.add('hidden');
        updateStatus('Ready to connect', false);
    }
});

/* ========= Event listeners ========= */
createSessionBtn.addEventListener('click', () => {
    // ensure a code exists before creating
    if(!sessionCodeInput.value.trim()){
        showNotification('Enter or generate a session code before creating', true);
        return;
    }
    startSession(true);
});

openJoinBtn.addEventListener('click', () => {
    // handled above; this is kept for safety
    joinModal.classList.add('show');
    joinModal.setAttribute('aria-hidden', 'false');
});

joinNowBtn.addEventListener('click', () => { /* handled above */ });
joinCancelBtn.addEventListener('click', () => { /* handled above */ });

resumeSessionBtn.addEventListener('click', () => {
    const persistedName = localStorage.getItem('local_real_name') || '';
    if (persistedName) realNameInput.value = persistedName;
    
    if (!realNameInput.value.trim()) {
        showNotification('Type your real name to resume (local only).', true);
        return;
    }
    
    const persistedCode = localStorage.getItem('session_code') || displayCodeInput.value;
    if (persistedCode) sessionCodeInput.value = persistedCode;
    
    const isHost = (localStorage.getItem('session_role') === 'host');
    startSession(isHost);
});

copyCodeBtn.addEventListener('click', () => {
    const txt = displayCodeInput.value || sessionCodeInput.value || '';
    if(txt) copyToClipboard(txt); else showNotification('No code available to copy', true);
});

shareLocationBtn.addEventListener('click', shareMyLocation);

/* Chat send */
chatSend.addEventListener('click', () => {
    const txt = chatInput.value.trim();
    if(!txt) return;
    // append locally
    appendMessage('You: ' + txt, true);
    // send only alias + text
    if (conn && conn.open) {
        safeSend({ type:'chat', text: txt, clientAlias: myAlias });
    }
    chatInput.value = '';
});

/* allow Enter to send */
chatInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        chatSend.click();
    }
});

/* beforeunload warn */
window.addEventListener('beforeunload', (e) => {
    const sessionActive = localStorage.getItem('session_active') === 'true';
    if(sessionActive){
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
</body>
</html>
