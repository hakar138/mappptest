<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SecureHat — Private Location Sharing</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    /* Layout & theme */
    *{box-sizing:border-box;margin:0;padding:0;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{min-height:100vh;background:linear-gradient(135deg,#10203a,#13294f);color:#fff;padding:24px}
    .container{max-width:980px;margin:0 auto}

    header{text-align:center;margin-bottom:18px}
    .logo{display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:6px}
    .logo-icon{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(45deg,#ff7e5f,#feb47b);box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .logo-text{font-weight:800;font-size:1.6rem;background:linear-gradient(90deg,#ff7e5f,#feb47b);-webkit-background-clip:text;color:transparent}
    h1{font-size:1.6rem;margin-bottom:6px}
    .subtitle{opacity:.9;font-size:0.98rem}

    .privacy-notice{background:rgba(255,255,255,.05);padding:12px;border-radius:10px;border-left:4px solid #4cd137;margin:14px 0;display:flex;align-items:center;gap:10px}
    .card{background:rgba(255,255,255,.04);padding:18px;border-radius:12px;margin:12px 0;border:1px solid rgba(255,255,255,.06)}
    .card-title{display:flex;align-items:center;gap:10px;color:#feb47b;font-weight:700;margin-bottom:12px}

    .form-group{margin-bottom:14px}
    .form-label{display:block;font-weight:700;margin-bottom:6px}
    .form-note{font-size:.85rem;opacity:.85;margin-top:6px}
    .form-control{width:100%;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,.04);color:#fff;font-size:1rem}
    .form-control:focus{outline:2px solid rgba(255,126,95,.4);background:rgba(255,255,255,.06)}

    .btn-container{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.btn-container{grid-template-columns:1fr}}
    .btn{padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:linear-gradient(45deg,#ff7e5f,#feb47b);color:#fff;display:inline-flex;align-items:center;gap:8px;justify-content:center}
    .btn-outline{background:transparent;border:2px solid #ff7e5f;color:#ff7e5f}
    .btn-stop{background:linear-gradient(45deg,#e84118,#c23616);color:#fff}

    .code-container{display:flex;gap:10px;margin-top:10px}
    .code-input{flex:1;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,.03);text-align:center;letter-spacing:3px;font-weight:700;color:#fff}

    .map-container{height:420px;border-radius:12px;overflow:hidden;margin-top:14px;border:2px solid rgba(255,255,255,.04)}
    #map{width:100%;height:100%}

    .user-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:14px}
    .user-card{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.03)}
    .user-avatar{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(45deg,#4facfe,#00f2fe);font-weight:800}
    .user-info .user-name{font-weight:700}
    .status-dot{width:10px;height:10px;border-radius:50%;background:#4cd137;display:inline-block;margin-right:8px}

    .notification{position:fixed;right:18px;top:18px;background:rgba(0,0,0,.45);padding:12px 16px;border-radius:10px;backdrop-filter:blur(4px);transform:translateX(120%);transition:transform .32s;z-index:9000;color:#fff;border-left:4px solid #4cd137}
    .notification.show{transform:translateX(0)}
    .notification.error{border-left-color:#e84118}

    footer{text-align:center;margin-top:18px;font-size:0.9rem;opacity:.8}

    /* Modal: start hidden, .show class toggles it */
    #stop-confirmation{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.72);z-index:9999;pointer-events:none}
    #stop-confirmation.show{display:flex;pointer-events:auto}
    .confirmation-box{width:90%;max-width:520px;background:linear-gradient(135deg,#11264a,#183054);border-radius:12px;padding:22px;border:1px solid rgba(255,255,255,.06);box-shadow:0 18px 40px rgba(0,0,0,.6);text-align:center;pointer-events:auto}
    .confirmation-buttons{display:flex;gap:12px;justify-content:center;margin-top:16px}
    .hidden{display:none !important}
    /* small helpers */
    .muted{opacity:.9;font-size:.92rem}
</style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo">
            <div class="logo-icon"><i class="fas fa-user-secret" style="font-size:20px"></i></div>
            <div class="logo-text">SECUREHAT</div>
        </div>
        <h1>Private Location Sharing</h1>
        <div class="subtitle muted">Share your location securely — your real name stays local-only. Session persists until you press STOP.</div>
    </header>

    <div class="privacy-notice">
        <i class="fas fa-shield-alt" style="color:#4cd137"></i>
        <div><strong>Privacy Notice:</strong> Your real name is stored locally only and is never shared with others or logs.</div>
    </div>

    <!-- Setup -->
    <div class="card" id="setup-card">
        <div class="card-title"><i class="fas fa-user"></i> User Setup</div>

        <div class="form-group">
            <label class="form-label">Your Real Name (Local Only)</label>
            <input id="real-name" class="form-control" type="text" placeholder="Type your real name (required)">
            <div class="form-note">You must type your name each time you start/resume a session. It will be stored locally only and never transmitted.</div>
        </div>

        <div class="form-group">
            <label class="form-label">Session Code</label>
            <input id="session-code" class="form-control" type="text" placeholder="Enter 4+ character code">
            <div class="form-note">Use the same code to create or join a session (acts as a room key).</div>
        </div>

        <div class="btn-container">
            <button id="create-session" class="btn"><i class="fas fa-plus-circle"></i> Create Session</button>
            <button id="join-session" class="btn btn-outline"><i class="fas fa-user-friends"></i> Join Session</button>
        </div>
    </div>

    <!-- Active session card -->
    <div class="card hidden" id="session-card">
        <div class="card-title"><i class="fas fa-satellite"></i> Active Session</div>

        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
            <div style="background:rgba(255,255,255,.04);padding:8px;border-radius:999px;display:flex;align-items:center;gap:8px;">
                <span id="connection-dot" style="width:12px;height:12px;border-radius:50%;display:inline-block;background:#fbc531"></span>
                <div id="status-text">Ready to connect</div>
            </div>
            <div style="margin-left:auto">
                <span class="muted">Peers:</span> <span id="peer-count">0</span>
            </div>
        </div>

        <div class="code-container">
            <input id="display-code" class="code-input" readonly placeholder="Session Code">
            <button id="copy-code" class="btn btn-outline" title="Copy code"><i class="fas fa-copy"></i></button>
        </div>

        <div class="btn-container" style="margin-top:12px;grid-template-columns:1fr 1fr 1fr">
            <button id="resume-session" class="btn btn-outline"><i class="fas fa-play"></i> Resume</button>
            <button id="share-location" class="btn"><i class="fas fa-location-dot"></i> Share My Location</button>
            <button id="stop-session" class="btn btn-stop"><i class="fas fa-power-off"></i> Stop Session</button>
        </div>

        <div class="form-note" style="margin-top:10px">Note: you must re-type your real name to resume (local-only).</div>
    </div>

    <!-- Map -->
    <div class="card">
        <div class="card-title"><i class="fas fa-map-marked-alt"></i> Location Map</div>
        <div class="map-container"><div id="map"></div></div>
    </div>

    <!-- Connected users -->
    <div class="card">
        <div class="card-title"><i class="fas fa-users"></i> Connected Users</div>
        <div class="user-list" id="user-list">
            <div class="user-card" id="you-card">
                <div class="user-avatar">Y</div>
                <div class="user-info">
                    <div class="user-name">You</div>
                    <div class="user-location muted"><i class="fas fa-location-slash"></i> Location not shared</div>
                    <div style="margin-top:8px"><span class="status-dot"></span> Online</div>
                </div>
            </div>
        </div>
    </div>

    <footer><div>SecureHat © test — Privacy First | No DB | Session persists until stopped</div></footer>
</div>

<!-- Notification -->
<div id="notification" class="notification" role="status" aria-live="polite"><i class="fas fa-info-circle"></i> <span id="notification-message">Ready</span></div>

<!-- Stop confirmation modal -->
<div id="stop-confirmation" role="dialog" aria-modal="true" aria-labelledby="stop-title">
    <div class="confirmation-box">
        <h3 id="stop-title"><i class="fas fa-exclamation-triangle" style="color:#ffb86b"></i> Confirm Session Stop</h3>
        <p style="margin-top:8px">Are you sure you want to stop the current session? This will end the session (test-only).</p>
        <div class="confirmation-buttons">
            <button id="confirm-stop" class="btn btn-stop"><i class="fas fa-check"></i> Yes, Stop Session</button>
            <button id="cancel-stop" class="btn btn-outline"><i class="fas fa-times"></i> Cancel</button>
        </div>
    </div>
</div>

<script>
/* ========= DOM refs ========= */
const realNameInput = document.getElementById('real-name');
const sessionCodeInput = document.getElementById('session-code');
const createSessionBtn = document.getElementById('create-session');
const joinSessionBtn = document.getElementById('join-session');
const setupCard = document.getElementById('setup-card');
const sessionCard = document.getElementById('session-card');
const displayCodeInput = document.getElementById('display-code');
const copyCodeBtn = document.getElementById('copy-code');
const shareLocationBtn = document.getElementById('share-location');
const stopSessionBtn = document.getElementById('stop-session');
const resumeSessionBtn = document.getElementById('resume-session');
const statusText = document.getElementById('status-text');
const peerCount = document.getElementById('peer-count');
const connectionDot = document.getElementById('connection-dot');
const notification = document.getElementById('notification');
const notificationMessage = document.getElementById('notification-message');
const userList = document.getElementById('user-list');
const stopConfirmation = document.getElementById('stop-confirmation');
const confirmStopBtn = document.getElementById('confirm-stop');
const cancelStopBtn = document.getElementById('cancel-stop');

/* ========= State ========= */
let peer = null;
let conn = null;
let myAlias = generateAnonAlias();
let myMarker = null;
let peerMarker = null;
let notificationTimeout = null;
let sessionRoleCached = null;

/* ========= Map init ========= */
const map = L.map('map', { attributionControl: false }).setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

/* ========= Helpers ========= */
function generateAnonAlias(){ return 'User-' + Math.random().toString(36).slice(2,6).toUpperCase(); }

function showNotification(msg, isError=false, duration=2800){
    if(notificationTimeout) { clearTimeout(notificationTimeout); notificationTimeout=null; }
    notificationMessage.textContent = msg;
    notification.classList.add('show');
    if(isError) notification.classList.add('error'); else notification.classList.remove('error');
    notificationTimeout = setTimeout(()=>{ notification.classList.remove('show'); notification.classList.remove('error'); }, duration);
}

/* update status/light */
function updateStatus(text, connected=false){
    statusText.textContent = text;
    connectionDot.style.background = connected ? '#4cd137' : '#fbc531';
}

/* peer count */
function updatePeerCount(n){
    peerCount.textContent = String(n);
}

/* sanitize outgoing payloads (defensive) */
function safeSend(payload){
    if(!conn || conn.open === false) return;
    if(payload && typeof payload === 'object'){
        delete payload.local_real_name;
        delete payload.realName;
        delete payload.name;
    }
    try { conn.send(payload); } catch(e){ console.error('send failed', e); }
}

/* destroy peer safely */
function destroyExistingPeer(){
    if(conn){ try{ conn.close(); }catch(e){} conn=null; }
    if(peer){ try{ peer.destroy(); }catch(e){} peer=null; }
}

/* copy helper modern */
async function copyToClipboard(text){
    try {
        if(navigator.clipboard && window.isSecureContext){
            await navigator.clipboard.writeText(text);
        } else {
            const ta = document.createElement('textarea'); ta.value=text;
            ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        }
        showNotification('Code copied to clipboard');
    } catch(e){ console.error(e); showNotification('Copy failed', true); }
}

/* ========= Peer / Session logic ========= */
function startSession(isHost){
    const code = (sessionCodeInput.value || '').trim();
    const realName = (realNameInput.value || '').trim();

    // Enforce typing name each time (local-only)
    if(!realName){
        showNotification('Type your real name (local only) to proceed', true); return;
    }
    if(code.length < 4){
        showNotification('Enter a valid code (min 4 chars)', true); return;
    }

    // persist local and session flags (test-only)
    localStorage.setItem('local_real_name', realName);
    localStorage.setItem('session_code', code);
    localStorage.setItem('session_active', 'true');
    localStorage.setItem('session_role', isHost ? 'host' : 'joiner');
    sessionRoleCached = isHost ? 'host' : 'joiner';

    // UI changes
    setupCard.classList.add('hidden');
    sessionCard.classList.remove('hidden');
    displayCodeInput.value = code;
    updateStatus('Connecting...', false);
    updatePeerCount(0);

    // Reset any previous peer
    destroyExistingPeer();

    // Create PeerJS instance
    try {
        peer = isHost ? new Peer(code) : new Peer();
    } catch(e){
        console.error('Peer creation failed', e);
        showNotification('Failed to create peer: ' + String(e), true);
        updateStatus('Error', false);
        return;
    }

    // disable controls while establishing
    setControlsDisabled(true);

    // event handlers
    peer.on('open', (id) => {
        // if we're joiner, connect to host using session code
        if(!isHost){
            conn = peer.connect(code);
            conn.on('open', () => {
                updateStatus('Connected to host', true);
                updatePeerCount(1);
                showNotification('Connected to host');
                safeSend({ type:'alias', alias: myAlias });
            });
            conn.on('error', (err) => { console.error(err); showNotification('Connection error', true); });
            setupDataChannel(conn);
        } else {
            updateStatus('Hosting — waiting for peer', true);
            showNotification('Hosting session — share the code');
        }
        setControlsDisabled(false);
    });

    peer.on('connection', (connection) => {
        // host receives a connection
        conn = connection;
        setupDataChannel(conn);
        updateStatus('Peer connected', true);
        updatePeerCount(1);
        showNotification('Peer connected');
        // reply with alias
        safeSend({ type:'alias', alias: myAlias });
    });

    peer.on('error', (err) => {
        console.error('Peer error', err);
        showNotification('Peer error: ' + String(err), true);
        updateStatus('Error', false);
        setControlsDisabled(false);
    });

    peer.on('disconnected', () => {
        updateStatus('Disconnected', false);
        showNotification('Network disconnected', true);
        setControlsDisabled(false);
    });
}

/* data channel setup & handlers */
function setupDataChannel(connection){
    if(!connection) return;
    connection.on('data', (data) => {
        // defensive sanitization
        if(data && typeof data === 'object'){
            delete data.local_real_name; delete data.realName; delete data.name;
        }
        if(data.type === 'alias') updatePeerAlias(data);
        else if(data.type === 'location') updatePeerLocation(data);
    });

    connection.on('close', () => {
        updateStatus('Peer disconnected', false); updatePeerCount(0);
        if(peerMarker){ map.removeLayer(peerMarker); peerMarker=null; }
        showNotification('Peer disconnected');
    });

    connection.on('error', (err) => { console.error('Data channel error', err); });
}

/* show peer location on map */
function updatePeerLocation(d){
    const latitude = Number(d.latitude), longitude = Number(d.longitude);
    if(isNaN(latitude) || isNaN(longitude)) return;
    if(peerMarker) map.removeLayer(peerMarker);
    peerMarker = L.marker([latitude, longitude]).addTo(map).bindPopup('<b>Peer Location</b>').openPopup();
    if(!myMarker) map.setView([latitude, longitude], 13);
}

/* show peer alias in user list (anonymized only) */
function updatePeerAlias(data){
    const alias = (data && data.alias) ? String(data.alias) : generateAnonAlias();
    // prevent duplicate
    const existing = Array.from(userList.querySelectorAll('.user-name')).some(el => el.textContent === alias);
    if(existing) return;
    const div = document.createElement('div'); div.className='user-card';
    div.innerHTML = `<div class="user-avatar">${alias.charAt(0)}</div><div class="user-info"><div class="user-name">${alias}</div><div class="user-location muted"><i class="fas fa-location-dot"></i> Location shared</div><div style="margin-top:8px"><span class="status-dot"></span> Online</div></div>`;
    const youCard = document.getElementById('you-card');
    userList.insertBefore(div, youCard.nextSibling);
}

/* share location (sends only lat/lon and alias) */
function shareMyLocation(){
    if(!conn || conn.open === false){ showNotification('No open connection. Resume or create session first.', true); return; }
    if(!navigator.geolocation){ showNotification('Geolocation not supported', true); return; }

    shareLocationBtn.disabled = true;
    shareLocationBtn.innerHTML = `<i class="fas fa-sync fa-spin"></i> Getting...`;

    navigator.geolocation.getCurrentPosition(pos => {
        const latitude = pos.coords.latitude, longitude = pos.coords.longitude;
        // local UI update
        const myCard = document.getElementById('you-card');
        myCard.querySelector('.user-location').innerHTML = `<i class="fas fa-location-dot"></i> Location shared`;
        myCard.querySelector('.user-avatar').classList.add('pulse');

        if(myMarker) map.removeLayer(myMarker);
        myMarker = L.marker([latitude, longitude]).addTo(map).bindPopup('<b>Your Location</b>').openPopup();
        map.setView([latitude, longitude], 13);

        // send payload (safeSend will sanitize)
        safeSend({ type:'location', latitude: latitude, longitude: longitude, clientAlias: myAlias });

        shareLocationBtn.disabled = false;
        shareLocationBtn.innerHTML = `<i class="fas fa-location-dot"></i> Location Shared`;
        showNotification('Location shared');
    }, err => {
        console.error('Geolocation error', err);
        shareLocationBtn.disabled = false;
        shareLocationBtn.innerHTML = `<i class="fas fa-location-dot"></i> Share My Location`;
        showNotification('Could not get location (enable location services)', true);
    }, { enableHighAccuracy:true, maximumAge:30000, timeout:10000 });
}

/* stop session: destroys peer and clears session flags (called after confirm) */
function stopSession(){
    // destroy connections & peer
    destroyExistingPeer();

    // clear local session flags
    localStorage.removeItem('session_active');
    localStorage.removeItem('session_role');
    localStorage.removeItem('session_code');
    sessionRoleCached = null;

    // UI reset
    setupCard.classList.remove('hidden');
    sessionCard.classList.add('hidden');
    displayCodeInput.value = '';
    updateStatus('Ready to connect', false);
    updatePeerCount(0);

    // clear markers & user list (preserve "You" card)
    if(myMarker){ map.removeLayer(myMarker); myMarker=null; }
    if(peerMarker){ map.removeLayer(peerMarker); peerMarker=null; }

    userList.innerHTML = `<div class="user-card" id="you-card"><div class="user-avatar">Y</div><div class="user-info"><div class="user-name">You</div><div class="user-location muted"><i class="fas fa-location-slash"></i> Location not shared</div><div style="margin-top:8px"><span class="status-dot"></span> Online</div></div></div>`;

    showNotification('Session stopped (test-only)');
}

/* control helper */
function setControlsDisabled(state){
    [createSessionBtn, joinSessionBtn, shareLocationBtn, resumeSessionBtn, copyCodeBtn].forEach(b => { if(b) b.disabled = state; });
}

/* ========= Modal behavior (fixed) ========= */
function showStopModal(){
    const sessionActive = localStorage.getItem('session_active') === 'true';
    if(!sessionActive){ showNotification('No active session to stop', true); return; }
    stopConfirmation.classList.add('show');
    confirmStopBtn.focus();
}
function hideStopModal(){ stopConfirmation.classList.remove('show'); }

stopSessionBtn.addEventListener('click', (e) => { showStopModal(); });
confirmStopBtn.addEventListener('click', (e) => {
    hideStopModal();
    setTimeout(()=> stopSession(), 120); // small delay so modal hides smoothly
});
cancelStopBtn.addEventListener('click', hideStopModal);
stopConfirmation.addEventListener('click', (e) => { if(e.target === stopConfirmation) hideStopModal(); });
const confirmationBox = stopConfirmation.querySelector('.confirmation-box');
if(confirmationBox) confirmationBox.addEventListener('click', (e)=> e.stopPropagation());
window.addEventListener('keydown', (e) => { if(e.key === 'Escape' && stopConfirmation.classList.contains('show')) hideStopModal(); });

/* ========= Resume & load handling ========= */
window.addEventListener('DOMContentLoaded', () => {
    // intentionally DO NOT auto-fill the real name into input
    const storedName = localStorage.getItem('local_real_name');
    if(storedName){
        // we don't auto-fill the name input; keep it empty so user types it each time
        // but optionally show a small hint comment (handled in UI text)
    }

    const sessionCode = localStorage.getItem('session_code');
    const sessionActive = localStorage.getItem('session_active') === 'true';
    const sessionRole = localStorage.getItem('session_role');

    if(sessionCode && sessionActive && sessionRole){
        // Show that a session exists server-side (test-only). User must type name and press Resume to reconnect.
        displayCodeInput.value = sessionCode;
        setupCard.classList.remove('hidden'); // show setup so user types name
        sessionCard.classList.remove('hidden'); // also show session so they can resume
        updateStatus('Session active (server-side). Type your name and press Resume.', false);
        updatePeerCount(0);
        sessionRoleCached = sessionRole;
    } else {
        setupCard.classList.remove('hidden');
        sessionCard.classList.add('hidden');
        updateStatus('Ready to connect', false);
    }
});

/* ========= Event listeners (buttons) ========= */
createSessionBtn.addEventListener('click', () => startSession(true));
joinSessionBtn.addEventListener('click', () => startSession(false));

resumeSessionBtn.addEventListener('click', () => {
    // require the user to type their name (do not auto-fill)
    if(!realNameInput.value.trim()){ showNotification('Type your real name to resume (local only).', true); return; }
    // populate sessionCodeInput from persisted value if missing
    const persistedCode = localStorage.getItem('session_code') || displayCodeInput.value;
    if(persistedCode) sessionCodeInput.value = persistedCode;
    const isHost = (localStorage.getItem('session_role') === 'host');
    startSession(isHost);
});

copyCodeBtn.addEventListener('click', () => {
    const txt = displayCodeInput.value || sessionCodeInput.value || '';
    if(txt) copyToClipboard(txt); else showNotification('No code available to copy', true);
});

shareLocationBtn.addEventListener('click', shareMyLocation);

/* beforeunload: warn user but DO NOT auto-stop session */
window.addEventListener('beforeunload', (e) => {
    const sessionActive = localStorage.getItem('session_active') === 'true';
    if(sessionActive){
        // modern browsers ignore custom message; this prevents accidental close and indicates session persists.
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
</body>
</html>
