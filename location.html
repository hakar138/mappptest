// Modal elements (re-select in case of replacement)
const stopConfirmation = document.getElementById('stop-confirmation');
const confirmStopBtn = document.getElementById('confirm-stop');
const cancelStopBtn = document.getElementById('cancel-stop');
const stopSessionBtn = document.getElementById('stop-session'); // main stop button

// Show the stop-confirmation modal (only if session active)
function showStopModal() {
    const sessionActive = localStorage.getItem('session_active') === 'true';
    if (!sessionActive) {
        showNotification('No active session to stop.', true);
        return;
    }
    stopConfirmation.classList.add('show'); // uses CSS to display
    // trap focus (optional basic focus)
    confirmStopBtn.focus();
}

// Hide the stop-confirmation modal
function hideStopModal() {
    stopConfirmation.classList.remove('show');
}

// Clicking the top-level Stop Session button opens modal (guarded)
stopSessionBtn.addEventListener('click', (e) => {
    // Only show modal when a session is actually active
    const sessionActive = localStorage.getItem('session_active') === 'true';
    if (!sessionActive) {
        showNotification('No active session to stop.', true);
        return;
    }
    showStopModal();
});

// Confirm -> stop session then hide modal
confirmStopBtn.addEventListener('click', (e) => {
    // Immediately hide modal to avoid double-click glitches
    hideStopModal();
    // Ensure stopSession runs after modal hides (short delay for UX)
    setTimeout(() => {
        try {
            stopSession();
        } catch (err) {
            console.error('Error stopping session:', err);
            showNotification('Error stopping session', true);
        }
    }, 120);
});

// Cancel -> just hide
cancelStopBtn.addEventListener('click', (e) => {
    hideStopModal();
});

// Clicking outside the confirmation box (overlay) cancels/hides the modal
stopConfirmation.addEventListener('click', (e) => {
    // if click target is the overlay (not inside .confirmation-box), hide
    if (e.target === stopConfirmation) {
        hideStopModal();
    }
});

// Prevent clicks inside the confirmation box from bubbling to the overlay
const confirmationBox = stopConfirmation.querySelector('.confirmation-box');
if (confirmationBox) {
    confirmationBox.addEventListener('click', (e) => {
        e.stopPropagation();
    });
}

// Close modal on Escape key
window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (stopConfirmation.classList.contains('show')) {
            hideStopModal();
        }
    }
});
