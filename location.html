<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SecureHat — Private Location Sharing & Chat (Improved)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js" defer></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <style>
    :root{
      --bg-1: #0d1c33; --bg-2: #10294f; --accent-1: #ff7e5f; --accent-2: #feb47b;
      --blue-1: #4facfe; --blue-2: #00f2fe; --muted: rgba(255,255,255,0.85);
      --card-bg: rgba(255,255,255,0.04); --glass: rgba(255,255,255,0.05);
      --success: #4cd137; --danger: #e84118;
      --rounded: 12px; --max-width: 980px;
      --font-sans: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;min-height:100vh;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));color:#fff;padding:16px; font-family:var(--font-sans)}
    .container{max-width:var(--max-width);margin:0 auto}

    header{text-align:center;margin-bottom:20px}
    .logo{display:flex;align-items:center;gap:12px;justify-content:center}
    .logo-icon{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(45deg,var(--accent-1),var(--accent-2));box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .logo-text{font-weight:800;font-size:1.6rem;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));-webkit-background-clip:text;color:transparent}
    h1{font-size:1.45rem;margin:6px 0}
    .subtitle{opacity:.9;font-size:1rem}

    .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card-bg);padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card-title{color:var(--accent-2);font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:10px}

    label{display:block;font-weight:700;margin-bottom:8px}
    .form-control{width:100%;padding:12px;border-radius:10px;border:none;background:var(--glass);color:inherit;font-size:1rem}
    .form-note{font-size:.9rem;opacity:.85;margin-top:8px}

    .btn{padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:linear-gradient(45deg,var(--accent-1),var(--accent-2));color:#fff;display:inline-flex;align-items:center;gap:8px}
    .btn-outline{background:transparent;border:2px solid var(--accent-1);color:var(--accent-1)}
    .btn-stop{background:linear-gradient(45deg,#e84118,#c23616)}
    .btn-small{padding:8px 10px;font-size:.95rem}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .code-row{display:flex;gap:8px;align-items:center}
    .code-input{flex:1;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);text-align:center;font-weight:700;letter-spacing:3px}

    .map-container{height:360px;border-radius:12px;overflow:hidden;border:2px solid rgba(255,255,255,0.06)}
    #map{width:100%;height:100%}

    .user-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .user-card{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)}
    .user-avatar{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(45deg,var(--blue-1),var(--blue-2));font-weight:800}

    .chat-card{display:flex;flex-direction:column;height:320px}
    .chat-messages{flex:1;overflow:auto;padding:12px;border-radius:8px;background:rgba(0,0,0,0.12);margin-bottom:10px;display:flex;flex-direction:column;gap:8px}
    .chat-input-row{display:flex;gap:8px}
    .chat-input{flex:1;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.04)}
    .chat-send{min-width:110px}

    .notification{position:fixed;right:16px;top:16px;background:rgba(0,0,0,.5);padding:12px 18px;border-radius:10px;backdrop-filter:blur(6px);transform:translateX(120%);transition:transform .35s;z-index:9000;border-left:4px solid var(--success)}
    .notification.show{transform:translateX(0)}
    .notification.error{border-left-color:var(--danger)}

    .hidden{display:none}
    .message-me{align-self:flex-end;background:linear-gradient(45deg,var(--accent-1),var(--accent-2));color:#000;padding:8px 12px;border-radius:12px}
    .message-peer{align-self:flex-start;background:rgba(255,255,255,0.08);color:#fff;padding:8px 12px;border-radius:12px}
    .message-system{text-align:center;color:rgba(255,255,255,0.85);font-style:italic}

    /* small screens */
    @media (max-width:600px){
      .logo{flex-direction:column}
      .grid{grid-template-columns:1fr}
      .map-container{height:260px}
      .chat-card{height:260px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon" aria-hidden="true"><i class="fas fa-user-secret" style="font-size:20px"></i></div>
        <div>
          <div class="logo-text">SECUREHAT</div>
          <div class="subtitle">Private Location Sharing &amp; Chat — Developed by Kurdistan Innovator Team</div>
        </div>
      </div>
      <h1>Private Location Sharing &amp; Chat</h1>
    </header>

    <div class="grid">
      <!-- left column (controls + map) -->
      <div style="display:flex;flex-direction:column;gap:16px">

        <section class="card" aria-labelledby="setup-title">
          <div id="setup-title" class="card-title"><i class="fas fa-user"></i> User Setup</div>

          <div>
            <label for="real-name">Your Real Name</label>
            <input id="real-name" class="form-control" type="text" inputmode="text" autocomplete="name" placeholder="Type your real name (required)" />
            <div class="form-note">Stored locally only. You must type it again to resume a session on another device.</div>
          </div>

          <div style="margin-top:12px">
            <label for="session-code">Session Code</label>
            <div class="code-row">
              <input id="session-code" class="code-input" type="password" placeholder="Enter or generate a secure code" aria-label="session code" />
              <button id="gen-code" class="btn btn-small" title="Generate secure code"><i class="fas fa-lock"></i></button>
              <button id="reveal-code" class="btn btn-outline btn-small" title="Reveal/Hide code">Reveal</button>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
              <div class="form-note" id="code-hint">Tip: generate a secure code to reduce guessing.</div>
              <button id="copy-session-code" class="btn btn-outline btn-small" disabled>Copy</button>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;align-items:center;gap:10px">
            <label style="margin:0">Show my real name to others</label>
            <input id="show-real-name-toggle" type="checkbox" aria-label="show real name" />
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="create-session" class="btn"><i class="fas fa-plus-circle"></i> Create Session</button>
            <button id="open-join" class="btn btn-outline"><i class="fas fa-user-friends"></i> Join Session</button>
            <button id="resume-session" class="btn btn-outline"><i class="fas fa-plug"></i> Resume</button>
          </div>
        </section>

        <section class="card" aria-labelledby="session-title" id="session-area">
          <div id="session-title" class="card-title"><i class="fas fa-satellite"></i> Active Session</div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
            <div style="display:flex;align-items:center;gap:8px">
              <div id="connection-dot" style="width:12px;height:12px;border-radius:50%;background:#fbc531" aria-hidden="true"></div>
              <div id="status-text">Ready to connect</div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="display:flex;align-items:center;gap:6px"><i class="fas fa-clock"></i> <span id="session-timer">00:00:00</span></div>
              <div id="host-indicator" class="hidden" style="background:rgba(251,197,49,0.15);color:#fbc531;padding:4px 8px;border-radius:8px;font-weight:700">HOST</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <input id="display-code" class="code-input" readonly aria-readonly="true" placeholder="Session Code" />
            <button id="copy-code" class="btn btn-outline btn-small" title="Copy code"><i class="fas fa-copy"></i></button>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="share-location" class="btn"><i class="fas fa-location-dot"></i> Share Location</button>
            <button id="stop-session" class="btn btn-stop"><i class="fas fa-power-off"></i> Stop</button>
          </div>

          <div id="location-controls" class="hidden" style="margin-top:12px;display:flex;gap:8px">
            <button id="update-location" class="btn btn-outline"><i class="fas fa-sync-alt"></i> Update Location</button>
            <button id="stop-sharing" class="btn btn-outline"><i class="fas fa-location-slash"></i> Stop Sharing</button>
          </div>

          <div style="margin-top:12px" class="form-note">Note: session data is peer-to-peer; nothing is saved to a server.</div>
        </section>

        <section class="card">
          <div class="card-title"><i class="fas fa-map-marked-alt"></i> Location Map</div>
          <div class="map-container"><div id="map" role="application" aria-label="map of locations"></div></div>
        </section>

      </div>

      <!-- right column (users + chat) -->
      <div style="display:flex;flex-direction:column;gap:12px">
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="card-title"><i class="fas fa-users"></i> Connected Users</div>
            <div class="form-note">Chat & messages are anonymized unless you share your name</div>
          </div>

          <div class="user-list" id="user-list">
            <div class="user-card" id="you-card">
              <div class="user-avatar">Y</div>
              <div>
                <div id="your-name-display" style="font-weight:700">You <span style="background:rgba(79,172,254,0.15);color:var(--blue-1);padding:3px 8px;border-radius:16px;font-weight:700;font-size:.85rem;margin-left:8px"><i class="fas fa-clock"></i> <span id="your-duration">0s</span></span></div>
                <div class="form-note" style="margin-top:6px"><span class="dot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--danger);margin-right:8px"></span><span id="your-location-status">Location not shared</span></div>
              </div>
            </div>
          </div>
        </section>

        <section class="card chat-card" aria-live="polite">
          <div class="card-title"><i class="fas fa-comments"></i> Chat</div>
          <div class="chat-messages" id="chat-messages"><div class="message-system">Welcome to SecureHat! Create or join a session to start.</div></div>
          <div class="chat-input-row">
            <textarea id="chat-input" class="chat-input" rows="2" placeholder="Type a message..."></textarea>
            <button id="chat-send" class="chat-send btn"><i class="fas fa-paper-plane"></i> Send</button>
          </div>
        </section>
      </div>

    </div>

    <footer style="text-align:center;margin-top:18px;opacity:.9;font-size:.9rem">SecureHat © Privacy First | Peer-to-peer only</footer>
  </div>

  <!-- notification element -->
  <div id="notification" class="notification" role="status" aria-live="polite"><i class="fas fa-info-circle"></i> <span id="notification-message">Ready to start</span></div>

  <!-- minimal modals for join/stop kept accessible -->
  <div id="join-modal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="join-title">
    <div style="width:90%;max-width:480px;margin:40px auto;background:linear-gradient(135deg,#0e2340,#102e4a);padding:16px;border-radius:12px">
      <h3 id="join-title">Join Session</h3>
      <p class="form-note">Enter session code provided by the host.</p>
      <input id="join-code-input" class="form-control" placeholder="Enter join session code" />
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="join-cancel" class="btn btn-outline">Cancel</button>
        <button id="join-now" class="btn">Join</button>
      </div>
    </div>
  </div>

  <div id="stop-confirmation" class="hidden" role="dialog" aria-modal="true" aria-labelledby="stop-title">
    <div style="width:90%;max-width:520px;margin:40px auto;background:linear-gradient(135deg,#11264a,#183054);padding:18px;border-radius:12px;text-align:center">
      <h3 id="stop-title">Confirm Session Stop</h3>
      <p class="form-note">Are you sure you want to stop the session? This will end it for everyone.</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
        <button id="confirm-stop" class="btn btn-stop">Yes, Stop</button>
        <button id="cancel-stop" class="btn btn-outline">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
  // Improved script: encapsulated module, clearer state, multiple peers support (map of connections), better UX/ARIA
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // DOM refs
  const realNameInput = $('#real-name');
  const sessionCodeInput = $('#session-code');
  const genCodeBtn = $('#gen-code');
  const revealCodeBtn = $('#reveal-code');
  const copySessionCodeBtn = $('#copy-session-code');
  const showRealNameToggle = $('#show-real-name-toggle');
  const yourNameDisplay = $('#your-name-display');
  const locationControls = $('#location-controls');
  const updateLocationBtn = $('#update-location');
  const stopSharingBtn = $('#stop-sharing');
  const hostIndicator = $('#host-indicator');
  const createSessionBtn = $('#create-session');
  const openJoinBtn = $('#open-join');
  const joinModal = $('#join-modal');
  const joinCodeInput = $('#join-code-input');
  const joinNowBtn = $('#join-now');
  const joinCancelBtn = $('#join-cancel');
  const setupCard = $('#setup-card');
  const sessionArea = $('#session-area');
  const displayCodeInput = $('#display-code');
  const copyCodeBtn = $('#copy-code');
  const shareLocationBtn = $('#share-location');
  const stopSessionBtn = $('#stop-session');
  const resumeSessionBtn = $('#resume-session');
  const statusText = $('#status-text');
  const connectionDot = $('#connection-dot');
  const notification = $('#notification');
  const notificationMessage = $('#notification-message');
  const userList = $('#user-list');
  const stopConfirmation = $('#stop-confirmation');
  const confirmStopBtn = $('#confirm-stop');
  const cancelStopBtn = $('#cancel-stop');
  const chatMessages = $('#chat-messages');
  const chatInput = $('#chat-input');
  const chatSend = $('#chat-send');
  const codeHint = $('#code-hint');
  const sessionTimer = $('#session-timer');
  const yourDuration = $('#your-duration');
  const yourLocationStatus = $('#your-location-status');

  // state
  let peer = null;                 // local Peer object
  let conns = new Map();          // map<peerId, DataConnection>
  let myAlias = '';
  let myMarker = null;
  let peerMarkers = new Map();    // map<peerId, marker>
  let notificationTimeout = null;
  let codeRevealed = false;
  let autoHideTimeout = null;
  let sessionStartTime = null;
  let timerInterval = null;
  let isHost = false;

  // Map init
  const map = L.map('map', { attributionControl:false, center:[34.5,45.5], zoom:7 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  /* ---------- Utilities ---------- */
  function showNotification(msg, isError=false, duration=3500){
    if(notificationTimeout) clearTimeout(notificationTimeout);
    notificationMessage.textContent = msg;
    notification.classList.add('show');
    notification.classList.toggle('error', !!isError);
    notificationTimeout = setTimeout(()=> notification.classList.remove('show'), duration);
  }

  function updateStatus(text, connected=false){
    statusText.textContent = text;
    connectionDot.style.background = connected ? '#4cd137' : '#fbc531';
  }

  function formatDuration(ms){
    const s = Math.floor(ms/1000)%60, m = Math.floor(ms/60000)%60, h = Math.floor(ms/3600000);
    if(h>0) return `${h}h ${m}m ${s}s`;
    if(m>0) return `${m}m ${s}s`;
    return `${s}s`;
  }

  function appendMessage(text, fromMe=false, isSystem=false){
    const el = document.createElement('div');
    el.className = isSystem ? 'message-system' : (fromMe ? 'message-me' : 'message-peer');
    el.textContent = text;
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function generateAnonAlias(){
    const A=["Swift","Clever","Brave","Wise","Gentle","Fierce","Noble","Silent","Bright","Calm"];
    const B=["Fox","Eagle","Lion","Wolf","Hawk","Bear","Deer","Owl","Horse","Falcon"];
    return `${A[Math.floor(Math.random()*A.length)]} ${B[Math.floor(Math.random()*B.length)]}`;
  }

  function generateSecureCode(len=8){
    const alphabet='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const arr = new Uint8Array(len); window.crypto.getRandomValues(arr);
    return Array.from(arr).map(i=>alphabet[i%alphabet.length]).join('');
  }

  async function copyToClipboard(text){
    try{ if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); } else { const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); } showNotification('Copied to clipboard'); }
    catch(e){ console.error(e); showNotification('Copy failed', true); }
  }

  /* ---------- Code generation UI ---------- */
  genCodeBtn.addEventListener('click', ()=>{
    const c = generateSecureCode(10);
    sessionCodeInput.value = c;
    maskCodeDisplay();
    showNotification('Secure code generated');
  });

  function maskCodeDisplay(){ codeRevealed=false; sessionCodeInput.type='password'; revealCodeBtn.textContent='Reveal'; copySessionCodeBtn.disabled=true; if(autoHideTimeout) clearTimeout(autoHideTimeout); }
  function revealCodeTemporarily(){ if(!sessionCodeInput.value){ showNotification('No code to reveal', true); return; } codeRevealed=true; sessionCodeInput.type='text'; revealCodeBtn.textContent='Hide'; copySessionCodeBtn.disabled=false; if(autoHideTimeout) clearTimeout(autoHideTimeout); autoHideTimeout = setTimeout(()=>{ maskCodeDisplay(); showNotification('Code auto-hidden'); }, 20000); }

  revealCodeBtn.addEventListener('click', ()=>{ codeRevealed ? maskCodeDisplay() : revealCodeTemporarily(); });
  copySessionCodeBtn.addEventListener('click', ()=>{ if(!codeRevealed){ showNotification('Reveal code to copy', true); return; } copyToClipboard(sessionCodeInput.value); });

  /* ---------- Peer/session management ---------- */
  function createLocalPeer(id=null){
    try{
      // if id provided, we will try to claim that id (host) — otherwise auto id
      const p = id ? new Peer(id, { debug:2 }) : new Peer();
      p.on('error', e=>{ console.error('peer err', e); showNotification('Peer error: '+String(e), true); updateStatus('Error', false); });
      return p;
    } catch(e){ console.error(e); showNotification('Unable to create peer', true); return null; }
  }

  function startSession(host){
    isHost = !!host;
    const code = (sessionCodeInput.value||'').trim();
    const realName = (realNameInput.value||'').trim();
    if(!realName){ showNotification('Type your real name', true); return; }
    if(code.length < 4){ showNotification('Enter a valid code (min 4 chars)', true); return; }

    // alias selection
    myAlias = showRealNameToggle.checked ? realName : generateAnonAlias();
    displayCodeInput.value = code;

    // UI
    appendMessage(isHost ? 'You created a session. Share the code.' : `Joining session...`, false, true);
    sessionStartTime = Date.now(); if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(()=>{ sessionTimer.textContent = new Date(Date.now()-sessionStartTime).toISOString().substr(11,8); document.getElementById('your-duration').textContent = formatDuration(Date.now()-sessionStartTime); }, 1000);
    updateStatus(isHost ? 'Hosting — waiting for peers' : 'Connecting to host...', isHost);

    destroyPeer();

    // create peer
    peer = createLocalPeer(isHost ? code : null);
    if(!peer) return;

    // common events
    peer.on('open', id => {
      updateStatus(isHost ? 'Hosting' : 'Connected to Peer', true);
      showNotification(isHost ? 'Hosting — share code' : 'Connected');
      if(!isHost){ // connect to host
        tryConnectToHost(code);
      }
    });

    peer.on('connection', conn => {
      // accept and setup multiple connections
      setupConnectionHandlers(conn);
    });

    peer.on('disconnected', ()=>{ updateStatus('Disconnected', false); showNotification('Network disconnected', true); });
    peer.on('close', ()=>{ updateStatus('Closed', false); });
  }

  function tryConnectToHost(code){
    if(!peer) return;
    let attempts = 0; const MAX = 8; const interval = 1500;
    function attempt(){
      attempts++;
      try{
        const c = peer.connect(code, { reliable:true, serialization:'json' });
        setupConnectionHandlers(c);
      } catch(e){
        if(attempts < MAX) setTimeout(attempt, interval);
        else { showNotification('Unable to connect to host', true); updateStatus('Unable to connect', false); }
      }
    }
    attempt();
  }

  function setupConnectionHandlers(conn){
    // ensure unique id (peerjs gives connection.peer)
    const pid = conn.peer;
    conns.set(pid, conn);

    conn.on('open', ()=>{
      updateStatus('Peer connected', true);
      showNotification('Peer connected');
      // announce alias
      conn.send({ type:'alias', alias: myAlias });
      appendMessage(`${pid} connected`, false, true);
    });

    conn.on('data', data => handleIncomingMessage(pid, data));

    conn.on('close', ()=>{
      conns.delete(pid);
      removePeerMarker(pid);
      appendMessage(`${pid} disconnected`, false, true);
      showNotification('Peer disconnected');
    });

    conn.on('error', e=>{ console.error('conn err', e); showNotification('Connection error', true); });
  }

  function handleIncomingMessage(peerId, data){
    if(!data || !data.type) return;
    if(data.type === 'alias'){
      // show peer in user-list
      addOrUpdatePeerCard(peerId, data.alias || generateAnonAlias());
      appendMessage(`${data.alias} joined`, false, true);
    } else if(data.type === 'chat'){
      appendMessage(`${data.clientAlias || peerId}: ${data.text}`);
    } else if(data.type === 'location'){
      updatePeerLocation(peerId, Number(data.latitude), Number(data.longitude), data.clientAlias);
    }
  }

  function addOrUpdatePeerCard(pid, alias){
    // remove existing then add
    const existing = document.querySelector(`[data-peer="${pid}"]`);
    if(existing) existing.remove();
    const div = document.createElement('div'); div.className='user-card'; div.dataset.peer = pid;
    div.innerHTML = `<div class="user-avatar">${(alias||'P').charAt(0)}</div><div><div style="font-weight:700">${alias}</div><div class="form-note"><span class="peer-location-status">Location not shared</span></div></div>`;
    userList.appendChild(div);
  }

  function removePeerMarker(pid){
    const m = peerMarkers.get(pid); if(m){ map.removeLayer(m); peerMarkers.delete(pid); }
    const card = document.querySelector(`[data-peer="${pid}"]`); if(card) card.remove();
  }

  function updatePeerLocation(pid, lat, lng, alias){
    if(Number.isNaN(lat) || Number.isNaN(lng)) return;
    // update peer card
    const card = document.querySelector(`[data-peer="${pid}"]`);
    if(card) card.querySelector('.peer-location-status').textContent = 'Location shared';

    // update marker
    if(peerMarkers.has(pid)){ map.removeLayer(peerMarkers.get(pid)); peerMarkers.delete(pid); }
    const m = L.marker([lat, lng]).addTo(map).bindPopup(`<b>${alias||pid}'s Location</b>`);
    peerMarkers.set(pid, m);

    // adjust view if we have our location too
    if(myMarker){
      const bounds = L.latLngBounds([ myMarker.getLatLng(), [lat, lng] ]);
      map.fitBounds(bounds, { padding:[50,50] });
    } else {
      map.setView([lat, lng], 13);
    }
  }

  function destroyPeer(){
    if(conns.size){ conns.forEach(c=>{ try{ c.close(); }catch(e){} }); conns.clear(); }
    if(peer){ try{ peer.destroy(); }catch(e){} peer=null; }
    // remove peer markers/cards
    peerMarkers.forEach(m=>map.removeLayer(m)); peerMarkers.clear();
    $$('.user-card[data-peer]').forEach(n=>n.remove());
  }

  /* ---------- Location sharing ---------- */
  function shareMyLocation(){
    if(!peer){ showNotification('No active session', true); return; }
    if(!navigator.geolocation){ showNotification('Geolocation not supported', true); return; }

    shareLocationBtn.disabled = true; shareLocationBtn.textContent = 'Getting...';

    navigator.geolocation.getCurrentPosition(pos => {
      const lat=pos.coords.latitude, lng=pos.coords.longitude;
      // update my card
      yourLocationStatus.textContent = 'Location shared';
      if(myMarker){ map.removeLayer(myMarker); myMarker=null; }
      myMarker = L.marker([lat,lng]).addTo(map).bindPopup('<b>Your Location</b>').openPopup();

      // notify peers
      conns.forEach(c=>{ if(c.open) c.send({ type:'location', latitude:lat, longitude:lng, clientAlias:myAlias }); });

      shareLocationBtn.disabled=false; shareLocationBtn.innerHTML = '<i class="fas fa-location-dot"></i> Share Location';
      $('#location-controls').classList.remove('hidden');
      showNotification('Location shared');
    }, err => {
      console.error(err); showNotification('Could not get location', true); shareLocationBtn.disabled=false; shareLocationBtn.innerHTML = '<i class="fas fa-location-dot"></i> Share Location';
    }, { enableHighAccuracy:true, maximumAge:30000, timeout:10000 });
  }

  $('#update-location').addEventListener('click', ()=>{ shareMyLocation(); showNotification('Updating location...'); });
  stopSharingBtn.addEventListener('click', ()=>{
    if(myMarker){ map.removeLayer(myMarker); myMarker=null; }
    $('#your-location-status').textContent = 'Location not shared';
    $('#location-controls').classList.add('hidden');
    showNotification('Stopped sharing your location');
  });

  /* ---------- UI events ---------- */
  createSessionBtn.addEventListener('click', ()=>{ if(!sessionCodeInput.value.trim()){ showNotification('Enter or generate a code first', true); return; } startSession(true); hostIndicator.classList.remove('hidden'); isHost=true; });
  openJoinBtn.addEventListener('click', ()=>{ joinModal.classList.remove('hidden'); joinCodeInput.value=''; joinCodeInput.focus(); });
  joinCancelBtn.addEventListener('click', ()=> joinModal.classList.add('hidden'));
  joinNowBtn.addEventListener('click', ()=>{
    const code = (joinCodeInput.value||'').trim(); if(!code || code.length<4){ showNotification('Enter valid join code', true); return; }
    sessionCodeInput.value = code; joinModal.classList.add('hidden');
    if(!realNameInput.value.trim()){ showNotification('Type your real name before joining', true); return; }
    startSession(false);
  });

  resumeSessionBtn.addEventListener('click', ()=>{
    const savedName = localStorage.getItem('local_real_name') || '';
    if(savedName) realNameInput.value = savedName;
    if(!realNameInput.value.trim()){ showNotification('Type your real name to reconnect', true); return; }
    const savedCode = localStorage.getItem('session_code') || displayCodeInput.value;
    if(savedCode) sessionCodeInput.value = savedCode;
    const savedRole = localStorage.getItem('session_role') === 'host';
    startSession(savedRole);
  });

  copyCodeBtn.addEventListener('click', ()=>{ const txt = displayCodeInput.value || sessionCodeInput.value || ''; if(txt) copyToClipboard(txt); else showNotification('No code available', true); });
  $('#chat-send').addEventListener('click', ()=>{
    const txt = chatInput.value.trim(); if(!txt) return; appendMessage(`${myAlias}: ${txt}`, true); conns.forEach(c=>{ if(c.open) c.send({ type:'chat', text:txt, clientAlias:myAlias }); }); chatInput.value='';
  });
  chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('#chat-send').click(); } });

  stopSessionBtn.addEventListener('click', ()=>{ stopConfirmation.classList.remove('hidden'); });
  cancelStopBtn.addEventListener('click', ()=> stopConfirmation.classList.add('hidden'));
  confirmStopBtn.addEventListener('click', ()=>{ stopConfirmation.classList.add('hidden'); destroyPeer(); localStorage.removeItem('session_active'); localStorage.removeItem('session_code'); localStorage.removeItem('local_real_name'); sessionStartTime=null; if(timerInterval) clearInterval(timerInterval); $('#session-timer').textContent='00:00:00'; showNotification('Session stopped'); });

  // persist preferences
  showRealNameToggle.addEventListener('change', ()=> localStorage.setItem('show_real_name', showRealNameToggle.checked));

  window.addEventListener('DOMContentLoaded', ()=>{
    // restore some UI state
    const savedShow = localStorage.getItem('show_real_name') === 'true';
    showRealNameToggle.checked = savedShow;
    const savedName = localStorage.getItem('local_real_name'); if(savedName) realNameInput.value = savedName;
    const savedCode = localStorage.getItem('session_code'); if(savedCode){ displayCodeInput.value = savedCode; sessionCodeInput.value = savedCode; }
  });

  // before unload: warn if active
  window.addEventListener('beforeunload', (e)=>{
    if(peer){ e.preventDefault(); e.returnValue=''; }
  });
  </script>
</body>
</html>
